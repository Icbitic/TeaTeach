import { Task, Resource } from '../interfaces/StudentInterfaces';

interface TaskTypeStat {
  type: string;
  count: number;
  progress: number;
}

interface TaskTypeData {
  count: number;
  totalProgress: number;
}

@Component
export struct TaskManagement {
  @Link tasks: Task[];
  @State searchText: string = '';
  @State selectedTaskType: string = 'å…¨éƒ¨';
  @State showUploadDialog: boolean = false;
  @State uploadFile: Resource | null = null;
  @State showStatsDialog: boolean = false;

  private taskTypes: string[] = ['å…¨éƒ¨', 'ç« èŠ‚ä½œä¸š', 'è¯•å·ç­”é¢˜', 'è¯¾ç¨‹è§†é¢‘è§‚çœ‹', 'é˜…è¯»æ•™æ/PPT', 'æŠ¥å‘Šç±»æ–‡æ¡£ä¸Šä¼ '];

  build() {
    Column({ space: 20 }) {
      // ä»»åŠ¡ç®¡ç†æ ‡é¢˜
      Row({ space: 16 }) {
        Text('ğŸ“ æˆ‘çš„ä»»åŠ¡')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1);

        Button('ğŸ“Š å­¦ä¹ ç»Ÿè®¡')
          .backgroundColor('#10b981')
          .fontColor(Color.White)
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .onClick(() => {
            this.showLearningStats();
          });
      }

      // æœç´¢å’Œç­›é€‰
      Row({ space: 16 }) {
        TextInput({ placeholder: 'ğŸ” æœç´¢ä»»åŠ¡...', text: this.searchText })
          .onChange(v => this.searchText = v)
          .layoutWeight(1)
          .backgroundColor('#ffffff')
          .borderRadius(12)
          .padding({ left: 18, right: 18, top: 14, bottom: 14 })
          .fontSize(16);

        Button('ç­›é€‰')
          .backgroundColor('#f1f5f9')
          .fontColor('#64748b')
          .borderRadius(12)
          .padding({ left: 18, right: 18, top: 14, bottom: 14 })
          .fontSize(16);
      }

      // ä»»åŠ¡ç±»å‹ç­›é€‰
      Scroll() {
        Row({ space: 12 }) {
          ForEach(this.taskTypes, (type: string) => {
            Button(type)
              .backgroundColor(this.selectedTaskType === type ? '#6366f1' : '#ffffff')
              .fontColor(this.selectedTaskType === type ? Color.White : '#6b7280')
              .borderRadius(24)
              .padding({ left: 16, right: 16, top: 8, bottom: 8 })
              .fontSize(15)
              .border({ width: 1, color: this.selectedTaskType === type ? '#6366f1' : '#e5e7eb' })
              .onClick(() => {
                this.selectedTaskType = type;
              });
          });
        }
        .padding({ left: 4, right: 4 });
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off);

      // ä»»åŠ¡åˆ—è¡¨
      Scroll() {
        Column({ space: 16 }) {
          ForEach(this.getFilteredTasks(), (task: Task) => {
            this.buildTaskCard(task);
          });
        }
      }
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
      .layoutWeight(1)
      .width('100%')

      // ä¸Šä¼ å¯¹è¯æ¡†
      if (this.showUploadDialog) {
        this.buildUploadDialog();
      }

      // å­¦ä¹ ç»Ÿè®¡å¯¹è¯æ¡†
      if (this.showStatsDialog) {
        this.buildStatsDialog();
      }
    }
    .width('100%')
    .padding(16);
  }

  @Builder
  buildTaskCard(task: Task) {
    Column({ space: 16 }) {
      Row({ space: 16 }) {
        Column({ space: 8 }) {
          Text(task.title)
            .fontSize(19)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937')
            .lineHeight(26);

          Text(task.type)
            .fontSize(14)
            .fontColor('#6366f1')
            .backgroundColor('#eef2ff')
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .borderRadius(8)
            .border({ width: 1, color: '#ddd6fe' });
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1);

        Column({ space: 4 }) {
          Text(`${task.progress}%`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(task.progress === 100 ? '#10b981' : '#f59e0b')
            .textAlign(TextAlign.Center);

          Text('å®Œæˆåº¦')
            .fontSize(12)
            .fontColor('#9ca3af')
            .textAlign(TextAlign.Center);
        }
        .alignItems(HorizontalAlign.Center);
      }

      Text(task.description)
        .fontSize(15)
        .fontColor('#6b7280')
        .lineHeight(22)
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis });

      // è¿›åº¦æ¡
      Column({ space: 8 }) {
        Row() {
          Text('å­¦ä¹ è¿›åº¦')
            .fontSize(13)
            .fontColor('#9ca3af');

          Blank();

          Text(`${task.progress}/100`)
            .fontSize(13)
            .fontColor('#9ca3af');
        }

        Progress({ value: task.progress, total: 100, type: ProgressType.Linear })
          .color('#6366f1')
          .backgroundColor('#e5e7eb')
          .width('100%')
          .height(6);
      }

      Row({ space: 16 }) {
        Text(`ğŸ“… æˆªæ­¢ï¼š${task.deadline}`)
          .fontSize(14)
          .fontColor('#6b7280')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .backgroundColor('#f9fafb')
          .borderRadius(6);

        Blank();

        if (task.status === 'pending') {
          Button('å¼€å§‹å­¦ä¹ ')
            .backgroundColor('#10b981')
            .fontColor(Color.White)
            .borderRadius(10)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .fontSize(15)
            .onClick(() => {
              this.startTask(task);
            });
        } else if (task.status === 'in_progress') {
          Button('ç»§ç»­å­¦ä¹ ')
            .backgroundColor('#f59e0b')
            .fontColor(Color.White)
            .borderRadius(10)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .fontSize(15)
            .onClick(() => {
              this.continueTask(task);
            });
        } else {
          Button('å·²å®Œæˆ')
            .backgroundColor('#6b7280')
            .fontColor(Color.White)
            .borderRadius(10)
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
            .fontSize(15)
            .enabled(false);
        }
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#ffffff')
    .borderRadius(16)
    .shadow({ radius: 6, color: '#00000012', offsetX: 0, offsetY: 3 })
    .border({ width: 1, color: '#f3f4f6' });
  }

  @Builder
  buildUploadDialog() {
    Column({ space: 16 }) {
      Text('ä¸Šä¼ æ–‡ä»¶')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937');

      Column({ space: 12 }) {
        Text('ğŸ“ é€‰æ‹©æ–‡ä»¶')
          .fontSize(16)
          .fontColor('#374151')
          .width('100%')
          .textAlign(TextAlign.Start);

        Button('ç‚¹å‡»é€‰æ‹©æ–‡ä»¶')
          .backgroundColor('#f8fafc')
          .fontColor('#6b7280')
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          .width('100%')
          .border({ width: 2, color: '#e5e7eb', style: BorderStyle.Dashed })
          .onClick(() => {
            this.selectFile();
          });

        if (this.uploadFile) {
          Row({ space: 12 }) {
            Text('ğŸ“„')
              .fontSize(20);

            Column({ space: 4 }) {
              Text(this.uploadFile.name)
                .fontSize(14)
                .fontColor('#374151')
                .fontWeight(FontWeight.Medium);

              Text(this.uploadFile.size)
                .fontSize(12)
                .fontColor('#9ca3af');
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1);

            Button('âŒ')
              .backgroundColor('transparent')
              .fontColor('#ef4444')
              .padding(4)
              .onClick(() => {
                this.uploadFile = null;
              });
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#f8fafc')
          .borderRadius(8);
        }
      }

      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .backgroundColor('#f3f4f6')
          .fontColor('#6b7280')
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .layoutWeight(1)
          .onClick(() => {
            this.showUploadDialog = false;
            this.uploadFile = null;
          });

        Button('ä¸Šä¼ ')
          .backgroundColor('#6366f1')
          .fontColor(Color.White)
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .layoutWeight(1)
          .enabled(this.uploadFile !== null)
          .onClick(() => {
            this.uploadFileToServer();
          });
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 4 });
  }

  // åŠŸèƒ½æ–¹æ³•
  getFilteredTasks(): Task[] {
    return this.tasks.filter(task => {
      let matchesSearch = task.title.toLowerCase().includes(this.searchText.toLowerCase()) ||
      task.description.toLowerCase().includes(this.searchText.toLowerCase());
      let matchesType = this.selectedTaskType === 'å…¨éƒ¨' || task.type === this.selectedTaskType;
      return matchesSearch && matchesType;
    });
  }

  startTask(task: Task) {
    console.log('å¼€å§‹ä»»åŠ¡:', task.title);
    task.status = 'in_progress';
    if (task.progress === 0) {
      task.progress = 10;
    }
    // æ ¹æ®ä»»åŠ¡ç±»å‹æ‰§è¡Œä¸åŒçš„æ“ä½œ
    this.handleTaskByType(task);
  }

  continueTask(task: Task) {
    console.log('ç»§ç»­ä»»åŠ¡:', task.title);
    this.handleTaskByType(task);
  }

  handleTaskByType(task: Task) {
    switch (task.type) {
      case 'ç« èŠ‚ä½œä¸š':
        this.openAssignment(task);
        break;
      case 'è¯•å·ç­”é¢˜':
        this.openExam(task);
        break;
      case 'è¯¾ç¨‹è§†é¢‘è§‚çœ‹':
        this.openVideo(task);
        break;
      case 'é˜…è¯»æ•™æ/PPT':
        this.openReading(task);
        break;
      case 'æŠ¥å‘Šç±»æ–‡æ¡£ä¸Šä¼ ':
        this.showUploadDialog = true;
        break;
      default:
        console.log('æœªçŸ¥ä»»åŠ¡ç±»å‹');
    }
  }

  openAssignment(task: Task) {
    console.log('æ‰“å¼€ä½œä¸š:', task.title);
    // æ¨¡æ‹Ÿæ‰“å¼€ä½œä¸šé¡µé¢
    this.showTaskProgress(task, 'æ­£åœ¨åŠ è½½ä½œä¸šå†…å®¹...');
    // å®é™…é¡¹ç›®ä¸­è¿™é‡Œåº”è¯¥å¯¼èˆªåˆ°ä½œä¸šç»„ä»¶
    // router.pushUrl({ url: 'pages/assignment', params: { taskId: task.id } });
  }

  openExam(task: Task) {
    console.log('æ‰“å¼€è€ƒè¯•:', task.title);
    // æ¨¡æ‹Ÿæ‰“å¼€è€ƒè¯•é¡µé¢
    this.showTaskProgress(task, 'æ­£åœ¨è¿›å…¥è€ƒè¯•æ¨¡å¼...');
    // å®é™…é¡¹ç›®ä¸­è¿™é‡Œåº”è¯¥å¯¼èˆªåˆ°åœ¨çº¿æµ‹éªŒç»„ä»¶
    // router.pushUrl({ url: 'pages/quiz', params: { taskId: task.id } });
  }

  openVideo(task: Task) {
    console.log('æ‰“å¼€è§†é¢‘:', task.title);
    // æ¨¡æ‹Ÿæ‰“å¼€è§†é¢‘é¡µé¢
    this.showTaskProgress(task, 'æ­£åœ¨åŠ è½½è§†é¢‘æ’­æ”¾å™¨...');
    // å®é™…é¡¹ç›®ä¸­è¿™é‡Œåº”è¯¥å¯¼èˆªåˆ°è§†é¢‘å­¦ä¹ ç»„ä»¶
    // router.pushUrl({ url: 'pages/video', params: { taskId: task.id } });
  }

  openReading(task: Task) {
    console.log('æ‰“å¼€é˜…è¯»ææ–™:', task.title);
    // æ¨¡æ‹Ÿæ‰“å¼€é˜…è¯»é¡µé¢
    this.showTaskProgress(task, 'æ­£åœ¨åŠ è½½é˜…è¯»ææ–™...');
    // å®é™…é¡¹ç›®ä¸­è¿™é‡Œåº”è¯¥å¯¼èˆªåˆ°èµ„æºé˜…è¯»é¡µé¢
    // router.pushUrl({ url: 'pages/reading', params: { taskId: task.id } });
  }

  showTaskProgress(task: Task, message: string) {
    // æ˜¾ç¤ºä»»åŠ¡è¿›åº¦æç¤º
    console.log(message);

    // æ¨¡æ‹Ÿå­¦ä¹ è¿›åº¦æ›´æ–°
    setTimeout(() => {
      if (task.progress < 100) {
        task.progress = Math.min(100, task.progress + 10);
        if (task.progress === 100) {
          task.status = 'completed';
          console.log(`ä»»åŠ¡ "${task.title}" å·²å®Œæˆï¼`);
        }
      }
    }, 1000);
  }

  selectFile() {
    console.log('é€‰æ‹©æ–‡ä»¶');
    // æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©
    this.uploadFile = {
      id: Date.now().toString(),
      name: 'å­¦ä¹ æŠ¥å‘Š.pdf',
      type: 'pdf',
      url: '',
      size: '2.5MB',
      uploadTime: new Date().toISOString()
    } as Resource;
  }

  uploadFileToServer() {
    console.log('ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨');
    // å®ç°æ–‡ä»¶ä¸Šä¼ é€»è¾‘
    this.showUploadDialog = false;
    this.uploadFile = null;
  }

  showLearningStats() {
    console.log('æ˜¾ç¤ºå­¦ä¹ ç»Ÿè®¡');
    this.showStatsDialog = true;
  }

  @Builder
  buildStatsDialog() {
    Column({ space: 20 }) {
      // æ ‡é¢˜æ 
      Row({ space: 16 }) {
        Text('ğŸ“Š å­¦ä¹ ç»Ÿè®¡')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .layoutWeight(1);

        Button('âœ•')
          .backgroundColor('transparent')
          .fontColor('#6b7280')
          .borderRadius(6)
          .padding(8)
          .onClick(() => {
            this.showStatsDialog = false;
          });
      }

      // æ€»ä½“ç»Ÿè®¡
      Column({ space: 16 }) {
        Text('æ€»ä½“è¿›åº¦')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .width('100%')
          .textAlign(TextAlign.Start);

        Row({ space: 20 }) {
          this.buildStatCard('æ€»ä»»åŠ¡æ•°', this.tasks.length.toString(), '#6366f1');
          this.buildStatCard('å·²å®Œæˆ', this.getCompletedTasksCount().toString(), '#10b981');
          this.buildStatCard('è¿›è¡Œä¸­', this.getInProgressTasksCount().toString(), '#f59e0b');
          this.buildStatCard('å¾…å¼€å§‹', this.getPendingTasksCount().toString(), '#6b7280');
        }

        // å®Œæˆç‡
        Column({ space: 8 }) {
          Row() {
            Text('æ•´ä½“å®Œæˆç‡')
              .fontSize(16)
              .fontColor('#374151')
              .fontWeight(FontWeight.Medium);

            Blank();

            Text(`${this.getOverallProgress()}%`)
              .fontSize(16)
              .fontColor('#6366f1')
              .fontWeight(FontWeight.Bold);
          }

          Progress({ value: this.getOverallProgress(), total: 100, type: ProgressType.Linear })
            .color('#6366f1')
            .backgroundColor('#e5e7eb')
            .width('100%')
            .height(8);
        }
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#f8fafc')
      .borderRadius(12);

      // ä»»åŠ¡ç±»å‹ç»Ÿè®¡
      Column({ space: 16 }) {
        Text('ä»»åŠ¡ç±»å‹åˆ†å¸ƒ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .width('100%')
          .textAlign(TextAlign.Start);

        ForEach(this.getTaskTypeStats(), (stat: TaskTypeStat) => {
          Row({ space: 12 }) {
            Text(stat.type)
              .fontSize(14)
              .fontColor('#374151')
              .layoutWeight(1);

            Text(`${stat.count}ä¸ª`)
              .fontSize(14)
              .fontColor('#6b7280');

            Text(`${stat.progress}%`)
              .fontSize(14)
              .fontColor('#6366f1')
              .fontWeight(FontWeight.Medium);
          }
          .width('100%')
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .backgroundColor('#ffffff')
          .borderRadius(8);
        });
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#f8fafc')
      .borderRadius(12);

      // å­¦ä¹ å»ºè®®
      Column({ space: 12 }) {
        Text('å­¦ä¹ å»ºè®®')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .width('100%')
          .textAlign(TextAlign.Start);

        ForEach(this.getLearningAdvice(), (advice: string) => {
          Row({ space: 8 }) {
            Text('ğŸ’¡')
              .fontSize(16);

            Text(advice)
              .fontSize(14)
              .fontColor('#374151')
              .lineHeight(20)
              .layoutWeight(1);
          }
          .width('100%')
          .padding(12)
          .backgroundColor('#ffffff')
          .borderRadius(8);
        });
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#f8fafc')
      .borderRadius(12);
    }
    .width('100%')
    .padding(24)
    .backgroundColor('#ffffff')
    .borderRadius(16)
    .shadow({ radius: 12, color: '#00000025', offsetX: 0, offsetY: 6 })
    .margin({ left: 20, right: 20, top: 40, bottom: 40 });
  }

  @Builder
  buildStatCard(title: string, value: string, color: string) {
    Column({ space: 8 }) {
      Text(value)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(color);

      Text(title)
        .fontSize(12)
        .fontColor('#6b7280');
    }
    .alignItems(HorizontalAlign.Center)
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .layoutWeight(1)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 });
  }

  // ç»Ÿè®¡ç›¸å…³æ–¹æ³•
  getCompletedTasksCount(): number {
    return this.tasks.filter(task => task.status === 'completed').length;
  }

  getInProgressTasksCount(): number {
    return this.tasks.filter(task => task.status === 'in_progress').length;
  }

  getPendingTasksCount(): number {
    return this.tasks.filter(task => task.status === 'pending').length;
  }

  getOverallProgress(): number {
    if (this.tasks.length === 0) return 0;
    const totalProgress = this.tasks.reduce((sum, task) => sum + task.progress, 0);
    return Math.round(totalProgress / this.tasks.length);
  }

  getTaskTypeStats(): TaskTypeStat[] {
    const typeMap = new Map<string, TaskTypeData>();

    this.tasks.forEach(task => {
      if (task.type !== 'å…¨éƒ¨') {
        const existing: TaskTypeData = typeMap.get(task.type) || { count: 0, totalProgress: 0 };
        const newData: TaskTypeData = {
          count: existing.count + 1,
          totalProgress: existing.totalProgress + task.progress
        };
        typeMap.set(task.type, newData);
      }
    });

    return Array.from(typeMap.entries()).map((entry) => {
      const result: TaskTypeStat = {
        type: entry[0],
        count: entry[1].count,
        progress: Math.round(entry[1].totalProgress / entry[1].count)
      };
      return result;
    });
  }

  getLearningAdvice(): string[] {
    const advice: string[] = [];
    const pendingTasks = this.getPendingTasksCount();
    const inProgressTasks = this.getInProgressTasksCount();
    const overallProgress = this.getOverallProgress();

    if (pendingTasks > 0) {
      advice.push(`æ‚¨è¿˜æœ‰ ${pendingTasks} ä¸ªä»»åŠ¡æœªå¼€å§‹ï¼Œå»ºè®®ä¼˜å…ˆå¤„ç†æˆªæ­¢æ—¥æœŸè¾ƒè¿‘çš„ä»»åŠ¡`);
    }

    if (inProgressTasks > 3) {
      advice.push('æ‚¨æœ‰è¾ƒå¤šè¿›è¡Œä¸­çš„ä»»åŠ¡ï¼Œå»ºè®®ä¸“æ³¨å®Œæˆå…¶ä¸­å‡ ä¸ªï¼Œé¿å…ä»»åŠ¡åˆ†æ•£');
    }

    if (overallProgress < 30) {
      advice.push('å­¦ä¹ è¿›åº¦è¾ƒæ…¢ï¼Œå»ºè®®åˆ¶å®šè¯¦ç»†çš„å­¦ä¹ è®¡åˆ’ï¼Œæ¯å¤©å®‰æ’å›ºå®šçš„å­¦ä¹ æ—¶é—´');
    } else if (overallProgress > 80) {
      advice.push('å­¦ä¹ è¿›åº¦å¾ˆå¥½ï¼ç»§ç»­ä¿æŒï¼Œæ³¨æ„å¤ä¹ å·²å®Œæˆçš„å†…å®¹');
    }

    if (advice.length === 0) {
      advice.push('å­¦ä¹ è¿›åº¦è‰¯å¥½ï¼Œç»§ç»­ä¿æŒè§„å¾‹çš„å­¦ä¹ èŠ‚å¥');
    }

    return advice;
  }
}