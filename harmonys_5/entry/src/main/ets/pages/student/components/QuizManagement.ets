import { Quiz, QuizQuestion } from '../interfaces/StudentInterfaces';

// ç§»é™¤äº†ä¸å†ä½¿ç”¨çš„æ¥å£å®šä¹‰ï¼Œæ”¹ä¸ºç›´æ¥çš„æ¡ä»¶åˆ¤æ–­

// æµ‹éªŒçŠ¶æ€æšä¸¾
enum QuizState {
  LIST = 'list',
  ACTIVE = 'active',
  RESULT = 'result'
}

// åˆ†æ•°ç­‰çº§æšä¸¾
enum ScoreLevel {
  EXCELLENT = 'excellent',
  GOOD = 'good',
  AVERAGE = 'average',
  PASS = 'pass',
  FAIL = 'fail'
}

@Component
export struct QuizManagement {
  @Link quizzes: Quiz[];
  @State currentQuiz: Quiz | null = null;
  @State currentQuestionIndex: number = 0;
  @State userAnswers: (string | string[])[] = [];
  @State quizTimeRemaining: number = 0;
  @State quizTimer: number = -1;
  @State currentScore: number = 0;
  @State searchText: string = '';
  @State selectedDifficulty: string = 'å…¨éƒ¨';
  @State quizState: QuizState = QuizState.LIST;

  // å¸¸é‡å®šä¹‰
  private readonly DIFFICULTIES: string[] = ['å…¨éƒ¨', 'easy', 'medium', 'hard'];
  private readonly WARNING_TIME_THRESHOLD: number = 300; // 5åˆ†é’Ÿè­¦å‘Šé˜ˆå€¼
  private readonly TIMER_INTERVAL: number = 1000; // è®¡æ—¶å™¨é—´éš”

  /**
   * ç»„ä»¶æ„å»ºæ–¹æ³•
   */
  build() {
    Column({ space: 20 }) {
      this.renderCurrentView();
    }
    .width('100%')
    .padding(16);
  }

  /**
   * æ ¹æ®å½“å‰çŠ¶æ€æ¸²æŸ“å¯¹åº”è§†å›¾
   */
  @Builder
  renderCurrentView() {
    if (this.quizState === QuizState.ACTIVE) {
      if (this.currentQuiz) {
        this.buildQuizInterface();
      }
    } else if (this.quizState === QuizState.RESULT) {
      this.buildQuizResult();
    } else {
      this.buildQuizList();
    }
  }

  /**
   * æ„å»ºæµ‹éªŒåˆ—è¡¨ç•Œé¢
   */
  @Builder
  buildQuizList() {
    Column({ space: 20 }) {
      this.buildHeader();
      this.buildSearchAndFilter();
      this.buildDifficultyFilter();
      this.buildQuizCards();
    }
  }

  /**
   * æ„å»ºé¡µé¢å¤´éƒ¨
   */
  @Builder
  buildHeader() {
    Row({ space: 16 }) {
      Text('ğŸ“ åœ¨çº¿æµ‹éªŒ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937')
        .layoutWeight(1);

      Button('ğŸ“Š æˆç»©ç»Ÿè®¡')
        .backgroundColor('#10b981')
        .fontColor(Color.White)
        .borderRadius(8)
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .onClick(() => this.handleShowScoreStats());
    }
  }

  /**
   * æ„å»ºæœç´¢å’Œç­›é€‰åŒºåŸŸ
   */
  @Builder
  buildSearchAndFilter() {
    Row({ space: 16 }) {
      TextInput({ placeholder: 'ğŸ” æœç´¢æµ‹éªŒ...', text: this.searchText })
        .onChange(value => this.handleSearchTextChange(value))
        .layoutWeight(1)
        .backgroundColor('#ffffff')
        .borderRadius(12)
        .padding({ left: 18, right: 18, top: 14, bottom: 14 })
        .fontSize(16);

      Button('ç­›é€‰')
        .backgroundColor('#f1f5f9')
        .fontColor('#64748b')
        .borderRadius(12)
        .padding({ left: 18, right: 18, top: 14, bottom: 14 })
        .fontSize(16)
        .onClick(() => this.handleShowFilter());
    }
  }

  /**
   * æ„å»ºéš¾åº¦ç­›é€‰å™¨
   */
  @Builder
  buildDifficultyFilter() {
    Scroll() {
      Row({ space: 12 }) {
        ForEach(this.DIFFICULTIES, (difficulty: string) => {
          this.buildDifficultyButton(difficulty);
        });
      }
      .padding({ left: 4, right: 4 });
    }
    .scrollable(ScrollDirection.Horizontal)
    .scrollBar(BarState.Off);
  }

  /**
   * æ„å»ºéš¾åº¦æŒ‰é’®
   */
  @Builder
  buildDifficultyButton(difficulty: string) {
    Button(this.getDifficultyLabel(difficulty))
      .backgroundColor(this.selectedDifficulty === difficulty ? '#6366f1' : '#ffffff')
      .fontColor(this.selectedDifficulty === difficulty ? Color.White : '#6b7280')
      .borderRadius(24)
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .fontSize(15)
      .border({
        width: 1,
        color: this.selectedDifficulty === difficulty ? '#6366f1' : '#e5e7eb'
      })
      .onClick(() => this.handleDifficultyChange(difficulty));
  }

  /**
   * æ„å»ºæµ‹éªŒå¡ç‰‡åˆ—è¡¨
   */
  @Builder
  buildQuizCards() {
    ForEach(this.getFilteredQuizzes(), (quiz: Quiz) => {
      this.buildQuizCard(quiz);
    });
  }

  /**
   * æ„å»ºå•ä¸ªæµ‹éªŒå¡ç‰‡
   */
  @Builder
  buildQuizCard(quiz: Quiz) {
    Column({ space: 16 }) {
      this.buildQuizCardHeader(quiz);
      this.buildQuizCardFooter(quiz);
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#ffffff')
    .borderRadius(16)
    .shadow({ radius: 6, color: '#00000012', offsetX: 0, offsetY: 3 })
    .border({ width: 1, color: '#f3f4f6' });
  }

  /**
   * æ„å»ºæµ‹éªŒå¡ç‰‡å¤´éƒ¨
   */
  @Builder
  buildQuizCardHeader(quiz: Quiz) {
    Row({ space: 16 }) {
      Column({ space: 8 }) {
        Text(quiz.title)
          .fontSize(19)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1f2937')
          .lineHeight(26);

        this.buildQuizTags(quiz);
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1);

      this.buildScoreDisplay(quiz);
    }
  }

  /**
   * æ„å»ºæµ‹éªŒæ ‡ç­¾
   */
  @Builder
  buildQuizTags(quiz: Quiz) {
    Row({ space: 8 }) {
      Text(`${quiz.questions.length}é¢˜`)
        .fontSize(14)
        .fontColor('#6366f1')
        .backgroundColor('#eef2ff')
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .borderRadius(6);

      Text(`${quiz.timeLimit}åˆ†é’Ÿ`)
        .fontSize(14)
        .fontColor('#f59e0b')
        .backgroundColor('#fef3c7')
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .borderRadius(6);
    }
  }

  /**
   * æ„å»ºåˆ†æ•°æ˜¾ç¤º
   */
  @Builder
  buildScoreDisplay(quiz: Quiz) {
    Column({ space: 4 }) {
      Text(`${quiz.bestScore}åˆ†`)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getScoreColor(quiz.bestScore))
        .textAlign(TextAlign.Center);

      Text('æœ€é«˜åˆ†')
        .fontSize(12)
        .fontColor('#9ca3af')
        .textAlign(TextAlign.Center);
    }
    .alignItems(HorizontalAlign.Center);
  }

  /**
   * æ„å»ºæµ‹éªŒå¡ç‰‡åº•éƒ¨
   */
  @Builder
  buildQuizCardFooter(quiz: Quiz) {
    Row({ space: 16 }) {
      Text(`ğŸ“Š å·²ç­”ï¼š${quiz.attempts}æ¬¡`)
        .fontSize(14)
        .fontColor('#6b7280')
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .backgroundColor('#f9fafb')
        .borderRadius(6);

      Blank();

      Button('å¼€å§‹æµ‹éªŒ')
        .backgroundColor('#6366f1')
        .fontColor(Color.White)
        .borderRadius(10)
        .padding({ left: 16, right: 16, top: 8, bottom: 8 })
        .fontSize(15)
        .onClick(() => this.handleStartQuiz(quiz));
    }
  }

  /**
   * æ„å»ºæµ‹éªŒç•Œé¢
   */
  @Builder
  buildQuizInterface() {
    Column({ space: 20 }) {
      this.buildQuizHeader();
      this.buildProgressBar();
      this.buildCurrentQuestion();
      this.buildNavigationButtons();
    }
  }

  /**
   * æ„å»ºæµ‹éªŒå¤´éƒ¨
   */
  @Builder
  buildQuizHeader() {
    Row({ space: 16 }) {
      this.buildQuizInfo();
      this.buildTimeDisplay();
    }
  }

  /**
   * æ„å»ºæµ‹éªŒä¿¡æ¯
   */
  @Builder
  buildQuizInfo() {
    Column({ space: 4 }) {
      Text(this.currentQuiz ? this.currentQuiz.title : '')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1f2937');

      Text(`ç¬¬ ${this.currentQuestionIndex + 1} é¢˜ / å…± ${this.getCurrentQuizQuestionCount()} é¢˜`)
        .fontSize(14)
        .fontColor('#6b7280');
    }
    .alignItems(HorizontalAlign.Start)
    .layoutWeight(1);
  }

  /**
   * æ„å»ºæ—¶é—´æ˜¾ç¤º
   */
  @Builder
  buildTimeDisplay() {
    Column({ space: 4 }) {
      Text(this.formatTime(this.quizTimeRemaining))
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getTimeColor())
        .textAlign(TextAlign.Center);

      Text('å‰©ä½™æ—¶é—´')
        .fontSize(12)
        .fontColor('#9ca3af')
        .textAlign(TextAlign.Center);
    }
    .alignItems(HorizontalAlign.Center);
  }

  /**
   * æ„å»ºè¿›åº¦æ¡
   */
  @Builder
  buildProgressBar() {
    Progress({
      value: this.currentQuestionIndex + 1,
      total: this.getCurrentQuizQuestionCount(),
      type: ProgressType.Linear
    })
      .color('#6366f1')
      .backgroundColor('#e5e7eb')
      .width('100%')
      .height(8);
  }

  /**
   * æ„å»ºå½“å‰é¢˜ç›®
   */
  @Builder
  buildCurrentQuestion() {
    if (this.currentQuiz && this.isValidQuestionIndex()) {
      this.buildQuestionCard(this.currentQuiz.questions[this.currentQuestionIndex]);
    }
  }

  /**
   * æ„å»ºå¯¼èˆªæŒ‰é’®
   */
  @Builder
  buildNavigationButtons() {
    Row({ space: 16 }) {
      this.buildPreviousButton();
      Blank();
      this.buildNextOrSubmitButton();
    }
  }

  /**
   * æ„å»ºä¸Šä¸€é¢˜æŒ‰é’®
   */
  @Builder
  buildPreviousButton() {
    Button('ä¸Šä¸€é¢˜')
      .backgroundColor('#f3f4f6')
      .fontColor('#6b7280')
      .borderRadius(10)
      .padding({ left: 20, right: 20, top: 12, bottom: 12 })
      .enabled(this.currentQuestionIndex > 0)
      .onClick(() => this.handlePreviousQuestion());
  }

  /**
   * æ„å»ºä¸‹ä¸€é¢˜æˆ–æäº¤æŒ‰é’®
   */
  @Builder
  buildNextOrSubmitButton() {
    if (this.isLastQuestion()) {
      Button('æäº¤æµ‹éªŒ')
        .backgroundColor('#10b981')
        .fontColor(Color.White)
        .borderRadius(10)
        .padding({ left: 20, right: 20, top: 12, bottom: 12 })
        .onClick(() => this.handleSubmitQuiz());
    } else {
      Button('ä¸‹ä¸€é¢˜')
        .backgroundColor('#6366f1')
        .fontColor(Color.White)
        .borderRadius(10)
        .padding({ left: 20, right: 20, top: 12, bottom: 12 })
        .onClick(() => this.handleNextQuestion());
    }
  }

  /**
   * æ„å»ºé¢˜ç›®å¡ç‰‡
   */
  @Builder
  buildQuestionCard(question: QuizQuestion) {
    Column({ space: 20 }) {
      this.buildQuestionContent(question);
      this.buildQuestionOptions(question);
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#ffffff')
    .borderRadius(16)
    .shadow({ radius: 6, color: '#00000012', offsetX: 0, offsetY: 3 })
    .border({ width: 1, color: '#f3f4f6' });
  }

  /**
   * æ„å»ºé¢˜ç›®å†…å®¹
   */
  @Builder
  buildQuestionContent(question: QuizQuestion) {
    Column({ space: 12 }) {
      this.buildQuestionTags(question);

      Text(question.question)
        .fontSize(18)
        .fontColor('#1f2937')
        .lineHeight(26)
        .fontWeight(FontWeight.Medium);
    }
  }

  /**
   * æ„å»ºé¢˜ç›®æ ‡ç­¾
   */
  @Builder
  buildQuestionTags(question: QuizQuestion) {
    Row({ space: 8 }) {
      Text(this.getDifficultyLabel(question.difficulty))
        .fontSize(12)
        .fontColor(this.getDifficultyColor(question.difficulty))
        .backgroundColor(this.getDifficultyBgColor(question.difficulty))
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .borderRadius(6);

      Text(question.type === 'choice' ? 'å•é€‰é¢˜' : 'å¤šé€‰é¢˜')
        .fontSize(12)
        .fontColor('#6366f1')
        .backgroundColor('#eef2ff')
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .borderRadius(6);
    }
  }

  /**
   * æ„å»ºé¢˜ç›®é€‰é¡¹
   */
  @Builder
  buildQuestionOptions(question: QuizQuestion) {
    if (question.type === 'choice') {
      this.buildChoiceOptions(question);
    } else if (question.type === 'multiple') {
      this.buildMultipleOptions(question);
    }
  }

  /**
   * æ„å»ºå•é€‰é¢˜é€‰é¡¹
   */
  @Builder
  buildChoiceOptions(question: QuizQuestion) {
    Column({ space: 12 }) {
      ForEach(this.getQuestionOptions(question), (option: string, index: number) => {
        this.buildChoiceOption(option, index);
      });
    }
  }

  /**
   * æ„å»ºå•é€‰é€‰é¡¹
   */
  @Builder
  buildChoiceOption(option: string, index: number) {
    Row({ space: 12 }) {
      Radio({ value: option, group: 'quiz_options' })
        .checked(this.isOptionSelected(option))
        .onChange((isChecked: boolean) => {
          if (isChecked) {
            this.handleSelectAnswer(option);
          }
        });

      Text(`${String.fromCharCode(65 + index)}. ${option}`)
        .fontSize(16)
        .fontColor('#374151')
        .lineHeight(24)
        .layoutWeight(1)
        .onClick(() => this.handleSelectAnswer(option));
    }
    .width('100%')
    .padding({ left: 12, right: 12, top: 12, bottom: 12 })
    .backgroundColor(this.isOptionSelected(option) ? '#eef2ff' : '#ffffff')
    .borderRadius(12)
    .border({
      width: 2,
      color: this.isOptionSelected(option) ? '#6366f1' : '#e5e7eb'
    })
    .onClick(() => this.handleSelectAnswer(option));
  }

  /**
   * æ„å»ºå¤šé€‰é¢˜é€‰é¡¹
   */
  @Builder
  buildMultipleOptions(question: QuizQuestion) {
    Column({ space: 12 }) {
      ForEach(this.getQuestionOptions(question), (option: string, index: number) => {
        this.buildMultipleOption(option, index);
      });
    }
  }

  /**
   * æ„å»ºå¤šé€‰é€‰é¡¹
   */
  @Builder
  buildMultipleOption(option: string, index: number) {
    Row({ space: 12 }) {
      Checkbox({ name: option, group: 'quiz_multiple' })
        .select(this.isMultipleOptionSelected(option))
        .onChange((value: boolean) => {
          this.handleToggleMultipleAnswer(option, value);
        });

      Text(`${String.fromCharCode(65 + index)}. ${option}`)
        .fontSize(16)
        .fontColor('#374151')
        .lineHeight(24)
        .layoutWeight(1)
        .onClick(() => {
          const isSelected = this.isMultipleOptionSelected(option);
          this.handleToggleMultipleAnswer(option, !isSelected);
        });
    }
    .width('100%')
    .padding({ left: 12, right: 12, top: 12, bottom: 12 })
    .backgroundColor(this.isMultipleOptionSelected(option) ? '#eef2ff' : '#ffffff')
    .borderRadius(12)
    .border({
      width: 2,
      color: this.isMultipleOptionSelected(option) ? '#6366f1' : '#e5e7eb'
    })
    .onClick(() => {
      const isSelected = this.isMultipleOptionSelected(option);
      this.handleToggleMultipleAnswer(option, !isSelected);
    });
  }

  /**
   * æ„å»ºæµ‹éªŒç»“æœç•Œé¢
   */
  @Builder
  buildQuizResult() {
    Column({ space: 24 }) {
      this.buildResultTitle();
      this.buildScoreSection();
      this.buildStatisticsSection();
      this.buildActionButtons();
    }
    .width('100%')
    .padding(20);
  }

  /**
   * æ„å»ºç»“æœæ ‡é¢˜
   */
  @Builder
  buildResultTitle() {
    Text('ğŸ‰ æµ‹éªŒå®Œæˆ')
      .fontSize(24)
      .fontWeight(FontWeight.Bold)
      .fontColor('#1f2937')
      .textAlign(TextAlign.Center);
  }

  /**
   * æ„å»ºåˆ†æ•°åŒºåŸŸ
   */
  @Builder
  buildScoreSection() {
    Column({ space: 16 }) {
      Text(`${this.currentScore}`)
        .fontSize(48)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getScoreColor(this.currentScore))
        .textAlign(TextAlign.Center);

      Text('åˆ†')
        .fontSize(20)
        .fontColor('#6b7280')
        .textAlign(TextAlign.Center);

      Text(this.getScoreLevelText(this.currentScore))
        .fontSize(18)
        .fontColor(this.getScoreColor(this.currentScore))
        .textAlign(TextAlign.Center)
        .fontWeight(FontWeight.Medium);
    }
    .width('100%')
    .padding(32)
    .backgroundColor('#ffffff')
    .borderRadius(20)
    .shadow({ radius: 8, color: '#00000015', offsetX: 0, offsetY: 4 });
  }

  /**
   * æ„å»ºç»Ÿè®¡ä¿¡æ¯åŒºåŸŸ
   */
  @Builder
  buildStatisticsSection() {
    Row({ space: 20 }) {
      this.buildStatItem('æ€»é¢˜æ•°', `${this.getCurrentQuizQuestionCount()}`, '#6366f1');
      this.buildStatItem('ç­”å¯¹é¢˜æ•°', `${this.getCorrectCount()}`, '#10b981');
      this.buildStatItem('æ­£ç¡®ç‡', `${this.getAccuracyRate()}%`, '#f59e0b');
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#ffffff')
    .borderRadius(16)
    .shadow({ radius: 6, color: '#00000012', offsetX: 0, offsetY: 3 });
  }

  /**
   * æ„å»ºç»Ÿè®¡é¡¹
   */
  @Builder
  buildStatItem(label: string, value: string, color: string) {
    Column({ space: 8 }) {
      Text(value)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
        .textAlign(TextAlign.Center);

      Text(label)
        .fontSize(14)
        .fontColor('#6b7280')
        .textAlign(TextAlign.Center);
    }
    .layoutWeight(1);
  }

  /**
   * æ„å»ºæ“ä½œæŒ‰é’®
   */
  @Builder
  buildActionButtons() {
    Column({ space: 12 }) {
      Button('æŸ¥çœ‹ç­”æ¡ˆè§£æ')
        .backgroundColor('#6366f1')
        .fontColor(Color.White)
        .borderRadius(12)
        .padding({ left: 24, right: 24, top: 14, bottom: 14 })
        .width('100%')
        .fontSize(16)
        .onClick(() => this.handleViewAnswers());

      Button('é‡æ–°æµ‹éªŒ')
        .backgroundColor('#10b981')
        .fontColor(Color.White)
        .borderRadius(12)
        .padding({ left: 24, right: 24, top: 14, bottom: 14 })
        .width('100%')
        .fontSize(16)
        .onClick(() => this.handleRestartQuiz());

      Button('è¿”å›æµ‹éªŒåˆ—è¡¨')
        .backgroundColor('#f3f4f6')
        .fontColor('#6b7280')
        .borderRadius(12)
        .padding({ left: 24, right: 24, top: 14, bottom: 14 })
        .width('100%')
        .fontSize(16)
        .onClick(() => this.handleExitQuiz());
    }
  }

  // ==================== äº‹ä»¶å¤„ç†æ–¹æ³• ====================

  /**
   * å¤„ç†æœç´¢æ–‡æœ¬å˜åŒ–
   */
  private handleSearchTextChange(value: string): void {
    this.searchText = value;
  }

  /**
   * å¤„ç†æ˜¾ç¤ºç­›é€‰
   */
  private handleShowFilter(): void {
    // TODO: å®ç°ç­›é€‰åŠŸèƒ½
    console.log('æ˜¾ç¤ºç­›é€‰é€‰é¡¹');
  }

  /**
   * å¤„ç†éš¾åº¦å˜åŒ–
   */
  private handleDifficultyChange(difficulty: string): void {
    this.selectedDifficulty = difficulty;
  }

  /**
   * å¤„ç†å¼€å§‹æµ‹éªŒ
   */
  private handleStartQuiz(quiz: Quiz): void {
    this.initializeQuiz(quiz);
    this.quizState = QuizState.ACTIVE;
    this.startQuizTimer();
  }

  /**
   * å¤„ç†æ˜¾ç¤ºæˆç»©ç»Ÿè®¡
   */
  private handleShowScoreStats(): void {
    // TODO: å®ç°æˆç»©ç»Ÿè®¡åŠŸèƒ½
    console.log('æ˜¾ç¤ºæˆç»©ç»Ÿè®¡');
  }

  /**
   * å¤„ç†é€‰æ‹©ç­”æ¡ˆ
   */
  private handleSelectAnswer(answer: string): void {
    this.userAnswers[this.currentQuestionIndex] = answer;
  }

  /**
   * å¤„ç†åˆ‡æ¢å¤šé€‰ç­”æ¡ˆ
   */
  private handleToggleMultipleAnswer(answer: string, selected: boolean): void {
    let currentAnswers = this.getCurrentMultipleAnswers();

    if (selected) {
      if (!currentAnswers.includes(answer)) {
        currentAnswers.push(answer);
      }
    } else {
      currentAnswers = currentAnswers.filter(a => a !== answer);
    }

    this.userAnswers[this.currentQuestionIndex] = currentAnswers;
  }

  /**
   * å¤„ç†ä¸Šä¸€é¢˜
   */
  private handlePreviousQuestion(): void {
    if (this.currentQuestionIndex > 0) {
      this.currentQuestionIndex--;
    }
  }

  /**
   * å¤„ç†ä¸‹ä¸€é¢˜
   */
  private handleNextQuestion(): void {
    if (!this.isLastQuestion()) {
      this.currentQuestionIndex++;
    }
  }

  /**
   * å¤„ç†æäº¤æµ‹éªŒ
   */
  private handleSubmitQuiz(): void {
    this.stopQuizTimer();
    this.calculateAndSetScore();
    this.updateQuizStatistics();
    this.quizState = QuizState.RESULT;
  }

  /**
   * å¤„ç†æŸ¥çœ‹ç­”æ¡ˆ
   */
  private handleViewAnswers(): void {
    // TODO: å®ç°ç­”æ¡ˆè§£æåŠŸèƒ½
    console.log('æŸ¥çœ‹ç­”æ¡ˆè§£æ');
  }

  /**
   * å¤„ç†é‡æ–°æµ‹éªŒ
   */
  private handleRestartQuiz(): void {
    if (this.currentQuiz) {
      this.handleStartQuiz(this.currentQuiz);
    }
  }

  /**
   * å¤„ç†é€€å‡ºæµ‹éªŒ
   */
  private handleExitQuiz(): void {
    this.resetQuizState();
    this.quizState = QuizState.LIST;
  }

  // ==================== æ ¸å¿ƒä¸šåŠ¡æ–¹æ³• ====================

  /**
   * åˆå§‹åŒ–æµ‹éªŒ
   */
  private initializeQuiz(quiz: Quiz): void {
    this.currentQuiz = quiz;
    this.currentQuestionIndex = 0;
    this.userAnswers = new Array(quiz.questions.length).fill(null);
    this.quizTimeRemaining = quiz.timeLimit * 60; // è½¬æ¢ä¸ºç§’
    this.currentScore = 0;
  }

  /**
   * é‡ç½®æµ‹éªŒçŠ¶æ€
   */
  private resetQuizState(): void {
    this.currentQuiz = null;
    this.currentQuestionIndex = 0;
    this.userAnswers = [];
    this.quizTimeRemaining = 0;
    this.currentScore = 0;
    this.stopQuizTimer();
  }

  /**
   * å¯åŠ¨æµ‹éªŒè®¡æ—¶å™¨
   */
  private startQuizTimer(): void {
    this.scheduleQuizTick();
  }

  /**
   * è°ƒåº¦æµ‹éªŒè®¡æ—¶
   */
  private scheduleQuizTick(): void {
    this.quizTimer = setTimeout(() => {
      this.quizTimeRemaining--;
      if (this.quizTimeRemaining <= 0) {
        this.handleSubmitQuiz();
      } else {
        this.scheduleQuizTick();
      }
    }, this.TIMER_INTERVAL);
  }

  /**
   * åœæ­¢æµ‹éªŒè®¡æ—¶å™¨
   */
  private stopQuizTimer(): void {
    if (this.quizTimer !== -1) {
      clearTimeout(this.quizTimer);
      this.quizTimer = -1;
    }
  }

  /**
   * è®¡ç®—å¹¶è®¾ç½®åˆ†æ•°
   */
  private calculateAndSetScore(): void {
    this.currentScore = this.calculateScore();
  }

  /**
   * è®¡ç®—åˆ†æ•°
   */
  private calculateScore(): number {
    if (!this.currentQuiz) return 0;

    const correctCount = this.getCorrectCount();
    return Math.round((correctCount / this.currentQuiz.questions.length) * 100);
  }

  /**
   * è·å–æ­£ç¡®ç­”æ¡ˆæ•°é‡
   */
  private getCorrectCount(): number {
    if (!this.currentQuiz) return 0;

    let correctCount = 0;

    for (let i = 0; i < this.currentQuiz.questions.length; i++) {
      const question = this.currentQuiz.questions[i];
      const userAnswer = this.userAnswers[i];

      if (this.isAnswerCorrect(question, userAnswer)) {
        correctCount++;
      }
    }

    return correctCount;
  }

  /**
   * åˆ¤æ–­ç­”æ¡ˆæ˜¯å¦æ­£ç¡®
   */
  private isAnswerCorrect(question: QuizQuestion, userAnswer: string | string[]): boolean {
    if (question.type === 'choice') {
      return userAnswer === question.correctAnswer;
    } else if (question.type === 'multiple') {
      const correctAnswers = question.correctAnswer as string[];
      const userAnswerArray = this.ensureStringArray(userAnswer);

      return correctAnswers.length === userAnswerArray.length &&
      correctAnswers.every(answer => userAnswerArray.includes(answer));
    }

    return false;
  }

  /**
   * æ›´æ–°æµ‹éªŒç»Ÿè®¡ä¿¡æ¯
   */
  private updateQuizStatistics(): void {
    if (!this.currentQuiz) return;

    // æ›´æ–°æœ€é«˜åˆ†
    if (this.currentScore > this.currentQuiz.bestScore) {
      this.currentQuiz.bestScore = this.currentScore;
    }

    // å¢åŠ å°è¯•æ¬¡æ•°
    this.currentQuiz.attempts++;
  }

  // ==================== å·¥å…·æ–¹æ³• ====================

  /**
   * è·å–ç­›é€‰åçš„æµ‹éªŒåˆ—è¡¨
   */
  private getFilteredQuizzes(): Quiz[] {
    return this.quizzes.filter(quiz => {
      const matchesSearch = this.matchesSearchCriteria(quiz);
      const matchesDifficulty = this.matchesDifficultyCriteria(quiz);
      return matchesSearch && matchesDifficulty;
    });
  }

  /**
   * æ£€æŸ¥æ˜¯å¦åŒ¹é…æœç´¢æ¡ä»¶
   */
  private matchesSearchCriteria(quiz: Quiz): boolean {
    return quiz.title.toLowerCase().includes(this.searchText.toLowerCase());
  }

  /**
   * æ£€æŸ¥æ˜¯å¦åŒ¹é…éš¾åº¦æ¡ä»¶
   */
  private matchesDifficultyCriteria(quiz: Quiz): boolean {
    if (this.selectedDifficulty === 'å…¨éƒ¨') {
      return true;
    }
    return quiz.questions.some(q => q.difficulty === this.selectedDifficulty);
  }

  /**
   * è·å–éš¾åº¦æ ‡ç­¾
   */
  private getDifficultyLabel(difficulty: string): string {
    if (difficulty === 'å…¨éƒ¨') return 'å…¨éƒ¨';
    if (difficulty === 'easy') return 'ç®€å•';
    if (difficulty === 'medium') return 'ä¸­ç­‰';
    if (difficulty === 'hard') return 'å›°éš¾';
    return difficulty;
  }

  /**
   * è·å–éš¾åº¦é¢œè‰²
   */
  private getDifficultyColor(difficulty: string): string {
    if (difficulty === 'easy') return '#10b981';
    if (difficulty === 'medium') return '#f59e0b';
    if (difficulty === 'hard') return '#ef4444';
    return '#6b7280';
  }

  /**
   * è·å–éš¾åº¦èƒŒæ™¯é¢œè‰²
   */
  private getDifficultyBgColor(difficulty: string): string {
    if (difficulty === 'easy') return '#d1fae5';
    if (difficulty === 'medium') return '#fef3c7';
    if (difficulty === 'hard') return '#fee2e2';
    return '#f3f4f6';
  }

  /**
   * è·å–åˆ†æ•°é¢œè‰²
   */
  private getScoreColor(score: number): string {
    if (score >= 90) return '#10b981'; // ä¼˜ç§€ - ç»¿è‰²
    if (score >= 80) return '#3b82f6'; // è‰¯å¥½ - è“è‰²
    if (score >= 70) return '#f59e0b'; // ä¸­ç­‰ - æ©™è‰²
    if (score >= 60) return '#eab308'; // åŠæ ¼ - é»„è‰²
    return '#ef4444'; // ä¸åŠæ ¼ - çº¢è‰²
  }

  /**
   * è·å–åˆ†æ•°ç­‰çº§æ–‡æœ¬
   */
  private getScoreLevelText(score: number): string {
    if (score >= 90) return 'ä¼˜ç§€';
    if (score >= 80) return 'è‰¯å¥½';
    if (score >= 70) return 'ä¸­ç­‰';
    if (score >= 60) return 'åŠæ ¼';
    return 'ä¸åŠæ ¼';
  }

  /**
   * è·å–æ—¶é—´é¢œè‰²
   */
  private getTimeColor(): string {
    return this.quizTimeRemaining <= this.WARNING_TIME_THRESHOLD ? '#ef4444' : '#6366f1';
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´
   */
  private formatTime(seconds: number): string {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
  }

  /**
   * è·å–å½“å‰æµ‹éªŒé¢˜ç›®æ•°é‡
   */
  private getCurrentQuizQuestionCount(): number {
    return this.currentQuiz ? this.currentQuiz.questions.length : 0;
  }

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆé¢˜ç›®ç´¢å¼•
   */
  private isValidQuestionIndex(): boolean {
    return this.currentQuestionIndex < this.getCurrentQuizQuestionCount();
  }

  /**
   * æ£€æŸ¥æ˜¯å¦ä¸ºæœ€åä¸€é¢˜
   */
  private isLastQuestion(): boolean {
    return this.currentQuestionIndex >= this.getCurrentQuizQuestionCount() - 1;
  }

  /**
   * è·å–é¢˜ç›®é€‰é¡¹
   */
  private getQuestionOptions(question: QuizQuestion): string[] {
    return question.options ? question.options : [];
  }

  /**
   * æ£€æŸ¥é€‰é¡¹æ˜¯å¦è¢«é€‰ä¸­
   */
  private isOptionSelected(option: string): boolean {
    return this.userAnswers[this.currentQuestionIndex] === option;
  }

  /**
   * æ£€æŸ¥å¤šé€‰é€‰é¡¹æ˜¯å¦è¢«é€‰ä¸­
   */
  private isMultipleOptionSelected(option: string): boolean {
    const currentAnswers = this.getCurrentMultipleAnswers();
    return currentAnswers.includes(option);
  }

  /**
   * è·å–å½“å‰å¤šé€‰ç­”æ¡ˆ
   */
  private getCurrentMultipleAnswers(): string[] {
    const answer = this.userAnswers[this.currentQuestionIndex];
    return this.ensureStringArray(answer);
  }

  /**
   * ç¡®ä¿è¿”å›å­—ç¬¦ä¸²æ•°ç»„
   */
  private ensureStringArray(value: string | string[]): string[] {
    if (Array.isArray(value)) {
      return value;
    }
    return [];
  }

  /**
   * è·å–æ­£ç¡®ç‡
   */
  private getAccuracyRate(): string {
    const total = this.getCurrentQuizQuestionCount();
    if (total === 0) return '0.0';

    const correct = this.getCorrectCount();
    return ((correct / total) * 100).toFixed(1);
  }
}