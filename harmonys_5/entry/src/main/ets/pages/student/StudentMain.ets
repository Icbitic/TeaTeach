import { Task, Resource, Quiz, QuizQuestion, KnowledgeNode, VideoProgress, WatchedSegment } from './interfaces/StudentInterfaces';
import { TaskManagement } from './components/TaskManagement';
import { QuizManagement } from './components/QuizManagement';
import { KnowledgeGraph } from './components/KnowledgeGraph';
import { VideoLearning } from './components/VideoLearning';

interface LearningStats {
  completed: number;
  total: number;
  averageProgress?: number;
  progress?: number;
  averageScore?: number;
}

interface StudentStats {
  tasks: LearningStats;
  quizzes: LearningStats;
  knowledge: LearningStats;
  videos: LearningStats;
}

@Component
export struct StudentMain {
  @State currentTab: number = 0;
  @State tasks: Task[] = [];
  @State quizzes: Quiz[] = [];
  @State knowledgeNodes: KnowledgeNode[] = [];
  @State videoProgresses: VideoProgress[] = [];
  @State userName: string = 'å¼ åŒå­¦';
  @State userAvatar: string = 'ðŸ‘¨â€ðŸŽ“';

  private tabTitles: string[] = ['ä»»åŠ¡ç®¡ç†', 'åœ¨çº¿æµ‹éªŒ', 'çŸ¥è¯†å›¾è°±', 'è§†é¢‘å­¦ä¹ '];
  private tabIcons: string[] = ['ðŸ“', 'ðŸ§ª', 'ðŸ§ ', 'ðŸŽ¥'];

  aboutToAppear() {
    this.initializeData();
  }

  build() {
    Column() {
      this.buildHeader();
      this.buildTabNavigation();
      this.buildContent();
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8fafc');
  }

  @Builder
  buildHeader() {
    Row({ space: 16 }) {
      // ç”¨æˆ·å¤´åƒå’Œä¿¡æ¯
      Row({ space: 12 }) {
        Text(this.userAvatar)
          .fontSize(32)
          .width(48)
          .height(48)
          .textAlign(TextAlign.Center)
          .backgroundColor('#ffffff')
          .borderRadius(24)
          .shadow({ radius: 4, color: '#00000015', offsetX: 0, offsetY: 2 });

        Column({ space: 4 }) {
          Text(`ä½ å¥½ï¼Œ${this.userName}`)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1f2937');

          Text('ç»§ç»­ä½ çš„å­¦ä¹ ä¹‹æ—…')
            .fontSize(14)
            .fontColor('#6b7280');
        }
        .alignItems(HorizontalAlign.Start);
      }
      .layoutWeight(1);

      // é€šçŸ¥å’Œè®¾ç½®
      Row({ space: 12 }) {
        Button('ðŸ””')
          .backgroundColor('#ffffff')
          .fontColor('#6b7280')
          .borderRadius(12)
          .padding(12)
          .shadow({ radius: 2, color: '#00000010', offsetX: 0, offsetY: 1 })
          .onClick(() => {
            this.showNotifications();
          });

        Button('âš™ï¸')
          .backgroundColor('#ffffff')
          .fontColor('#6b7280')
          .borderRadius(12)
          .padding(12)
          .shadow({ radius: 2, color: '#00000010', offsetX: 0, offsetY: 1 })
          .onClick(() => {
            this.showSettings();
          });
      }
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 16, bottom: 16 })
    .backgroundColor('#ffffff')
    .shadow({ radius: 4, color: '#00000008', offsetX: 0, offsetY: 2 });
  }

  @Builder
  buildTabNavigation() {
    Row() {
      ForEach(this.tabTitles, (title: string, index: number) => {
        Column({ space: 8 }) {
          Text(this.tabIcons[index])
            .fontSize(20)
            .fontColor(this.currentTab === index ? '#6366f1' : '#9ca3af');

          Text(title)
            .fontSize(14)
            .fontColor(this.currentTab === index ? '#6366f1' : '#9ca3af')
            .fontWeight(this.currentTab === index ? FontWeight.Bold : FontWeight.Normal);

          if (this.currentTab === index) {
            Rect()
              .width(24)
              .height(3)
              .fill('#6366f1')
              .borderRadius(2);
          }
        }
        .layoutWeight(1)
        .padding({ top: 16, bottom: 12 })
        .onClick(() => {
          this.currentTab = index;
        });
      });
    }
    .width('100%')
    .backgroundColor('#ffffff')
    .shadow({ radius: 2, color: '#00000005', offsetX: 0, offsetY: 1 });
  }

  @Builder
  buildContent() {
    Scroll() {
      Column() {
        if (this.currentTab === 0) {
          TaskManagement({ tasks: $tasks });
        } else if (this.currentTab === 1) {
          QuizManagement({ quizzes: $quizzes });
        } else if (this.currentTab === 2) {
          KnowledgeGraph({ knowledgeNodes: $knowledgeNodes });
        } else if (this.currentTab === 3) {
          VideoLearning({ videoProgresses: $videoProgresses });
        }
      }
      .width('100%')
      .height('100%');
    }
    .layoutWeight(1)
    .scrollBar(BarState.Auto)
    .backgroundColor('#f8fafc');
  }

  // æ•°æ®åˆå§‹åŒ–
  initializeData() {
    this.initializeTasks();
    this.initializeQuizzes();
    this.initializeKnowledgeNodes();
    this.initializeVideoProgresses();
  }

  initializeTasks() {
    this.tasks = [
      {
        id: 'task1',
        title: 'HarmonyOSåº”ç”¨å¼€å‘åŸºç¡€',
        type: 'ç« èŠ‚ä½œä¸š',
        deadline: '2024-01-15',
        description: 'å®ŒæˆHarmonyOSåº”ç”¨å¼€å‘åŸºç¡€ç« èŠ‚çš„ç»ƒä¹ é¢˜ï¼ŒåŒ…æ‹¬çŽ¯å¢ƒæ­å»ºã€é¡¹ç›®åˆ›å»ºç­‰å†…å®¹ã€‚',
        status: 'in_progress',
        progress: 65,
        resources: [
          {
            id: 'res1',
            name: 'HarmonyOSå¼€å‘æŒ‡å—.pdf',
            type: 'pdf',
            url: '/resources/harmony_guide.pdf',
            size: '5.2MB',
            uploadTime: '2024-01-10T10:00:00Z'
          }
        ]
      },
      {
        id: 'task2',
        title: 'ArkTSè¯­æ³•æµ‹éªŒ',
        type: 'è¯•å·ç­”é¢˜',
        deadline: '2024-01-20',
        description: 'å®ŒæˆArkTSè¯­æ³•ç›¸å…³çš„åœ¨çº¿æµ‹éªŒï¼Œæµ‹è¯•å¯¹TypeScriptæ‰©å±•è¯­æ³•çš„æŽŒæ¡ç¨‹åº¦ã€‚',
        status: 'pending',
        progress: 0
      },
      {
        id: 'task3',
        title: 'ç»„ä»¶å¼€å‘å®žæˆ˜è§†é¢‘',
        type: 'è¯¾ç¨‹è§†é¢‘è§‚çœ‹',
        deadline: '2024-01-25',
        description: 'è§‚çœ‹ç»„ä»¶å¼€å‘å®žæˆ˜ç³»åˆ—è§†é¢‘ï¼Œå­¦ä¹ è‡ªå®šä¹‰ç»„ä»¶çš„åˆ›å»ºå’Œä½¿ç”¨æ–¹æ³•ã€‚',
        status: 'in_progress',
        progress: 30
      },
      {
        id: 'task4',
        title: 'åº”ç”¨æž¶æž„è®¾è®¡æ–‡æ¡£',
        type: 'é˜…è¯»æ•™æ/PPT',
        deadline: '2024-01-30',
        description: 'é˜…è¯»åº”ç”¨æž¶æž„è®¾è®¡ç›¸å…³çš„PPTå’Œæ–‡æ¡£ï¼Œç†è§£MVVMæž¶æž„æ¨¡å¼ã€‚',
        status: 'pending',
        progress: 0
      },
      {
        id: 'task5',
        title: 'é¡¹ç›®å®žæˆ˜æŠ¥å‘Š',
        type: 'æŠ¥å‘Šç±»æ–‡æ¡£ä¸Šä¼ ',
        deadline: '2024-02-05',
        description: 'å®Œæˆä¸€ä¸ªå®Œæ•´çš„HarmonyOSåº”ç”¨é¡¹ç›®ï¼Œå¹¶æäº¤é¡¹ç›®æŠ¥å‘Šå’Œæºä»£ç ã€‚',
        status: 'pending',
        progress: 0
      }
    ];
  }

  initializeQuizzes() {
    this.quizzes = [
      {
        id: 'quiz1',
        title: 'HarmonyOSåŸºç¡€æµ‹éªŒ',
        questions: [
          {
            id: 'q1',
            type: 'choice',
            question: 'HarmonyOSæ˜¯ç”±å“ªå®¶å…¬å¸å¼€å‘çš„æ“ä½œç³»ç»Ÿï¼Ÿ',
            options: ['åŽä¸º', 'å°ç±³', 'é˜¿é‡Œå·´å·´', 'è…¾è®¯'],
            correctAnswer: 'åŽä¸º',
            difficulty: 'easy',
            knowledgePoints: ['HarmonyOSåŸºç¡€']
          },
          {
            id: 'q2',
            type: 'multiple',
            question: 'HarmonyOSæ”¯æŒå“ªäº›è®¾å¤‡ç±»åž‹ï¼Ÿï¼ˆå¤šé€‰ï¼‰',
            options: ['æ‰‹æœº', 'å¹³æ¿', 'æ™ºèƒ½æ‰‹è¡¨', 'æ™ºèƒ½ç”µè§†', 'è½¦è½½è®¾å¤‡'],
            correctAnswer: ['æ‰‹æœº', 'å¹³æ¿', 'æ™ºèƒ½æ‰‹è¡¨', 'æ™ºèƒ½ç”µè§†', 'è½¦è½½è®¾å¤‡'],
            difficulty: 'medium',
            knowledgePoints: ['HarmonyOSç‰¹æ€§']
          },
          {
            id: 'q3',
            type: 'choice',
            question: 'ArkTSæ˜¯åŸºäºŽå“ªç§ç¼–ç¨‹è¯­è¨€æ‰©å±•çš„ï¼Ÿ',
            options: ['JavaScript', 'TypeScript', 'Java', 'C++'],
            correctAnswer: 'TypeScript',
            difficulty: 'easy',
            knowledgePoints: ['ArkTSè¯­æ³•']
          }
        ],
        timeLimit: 30,
        attempts: 0,
        bestScore: 0
      },
      {
        id: 'quiz2',
        title: 'ArkTSè¯­æ³•æµ‹éªŒ',
        questions: [
          {
            id: 'q4',
            type: 'choice',
            question: 'åœ¨ArkTSä¸­ï¼Œ@Stateè£…é¥°å™¨çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ',
            options: ['å®šä¹‰å¸¸é‡', 'ç®¡ç†ç»„ä»¶çŠ¶æ€', 'åˆ›å»ºå‡½æ•°', 'å¯¼å…¥æ¨¡å—'],
            correctAnswer: 'ç®¡ç†ç»„ä»¶çŠ¶æ€',
            difficulty: 'medium',
            knowledgePoints: ['çŠ¶æ€ç®¡ç†']
          },
          {
            id: 'q5',
            type: 'multiple',
            question: 'ArkTSä¸­å¸¸ç”¨çš„è£…é¥°å™¨æœ‰å“ªäº›ï¼Ÿï¼ˆå¤šé€‰ï¼‰',
            options: ['@State', '@Prop', '@Link', '@Watch', '@Component'],
            correctAnswer: ['@State', '@Prop', '@Link', '@Watch', '@Component'],
            difficulty: 'hard',
            knowledgePoints: ['è£…é¥°å™¨']
          }
        ],
        timeLimit: 25,
        attempts: 0,
        bestScore: 0
      },
      {
        id: 'quiz3',
        title: 'ç»„ä»¶å¼€å‘å®žæˆ˜',
        questions: [
          {
            id: 'q6',
            type: 'choice',
            question: 'åˆ›å»ºè‡ªå®šä¹‰ç»„ä»¶æ—¶ï¼Œå¿…é¡»ä½¿ç”¨å“ªä¸ªè£…é¥°å™¨ï¼Ÿ',
            options: ['@State', '@Component', '@Builder', '@Styles'],
            correctAnswer: '@Component',
            difficulty: 'easy',
            knowledgePoints: ['ç»„ä»¶å¼€å‘']
          },
          {
            id: 'q7',
            type: 'choice',
            question: '@Builderè£…é¥°å™¨çš„ä¸»è¦ç”¨é€”æ˜¯ä»€ä¹ˆï¼Ÿ',
            options: ['ç®¡ç†çŠ¶æ€', 'åˆ›å»ºå¯å¤ç”¨UI', 'å®šä¹‰æ ·å¼', 'å¤„ç†äº‹ä»¶'],
            correctAnswer: 'åˆ›å»ºå¯å¤ç”¨UI',
            difficulty: 'medium',
            knowledgePoints: ['UIæž„å»º']
          }
        ],
        timeLimit: 20,
        attempts: 0,
        bestScore: 0
      }
    ];
  }

  initializeKnowledgeNodes() {
    this.knowledgeNodes = [
      {
        id: 'node1',
        title: 'HarmonyOSåŸºç¡€',
        description: 'äº†è§£HarmonyOSçš„åŸºæœ¬æ¦‚å¿µã€ç‰¹æ€§å’Œåº”ç”¨åœºæ™¯',
        x: 50,
        y: 50,
        connections: ['node2', 'node3'],
        completed: true
      },
      {
        id: 'node2',
        title: 'ArkTSè¯­æ³•',
        description: 'å­¦ä¹ ArkTSè¯­è¨€çš„åŸºæœ¬è¯­æ³•å’Œç‰¹æ€§',
        x: 200,
        y: 50,
        connections: ['node4', 'node5'],
        completed: true
      },
      {
        id: 'node3',
        title: 'å¼€å‘çŽ¯å¢ƒæ­å»º',
        description: 'é…ç½®HarmonyOSå¼€å‘çŽ¯å¢ƒå’Œå·¥å…·',
        x: 50,
        y: 150,
        connections: ['node4'],
        completed: true
      },
      {
        id: 'node4',
        title: 'ç»„ä»¶å¼€å‘',
        description: 'å­¦ä¹ åˆ›å»ºå’Œä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶',
        x: 200,
        y: 150,
        connections: ['node6', 'node7'],
        completed: false
      },
      {
        id: 'node5',
        title: 'çŠ¶æ€ç®¡ç†',
        description: 'æŽŒæ¡åº”ç”¨çŠ¶æ€ç®¡ç†çš„æ–¹æ³•å’Œæœ€ä½³å®žè·µ',
        x: 350,
        y: 50,
        connections: ['node6'],
        completed: false
      },
      {
        id: 'node6',
        title: 'åº”ç”¨æž¶æž„',
        description: 'ç†è§£HarmonyOSåº”ç”¨çš„æž¶æž„è®¾è®¡æ¨¡å¼',
        x: 280,
        y: 250,
        connections: ['node8'],
        completed: false
      },
      {
        id: 'node7',
        title: 'ç•Œé¢å¸ƒå±€',
        description: 'å­¦ä¹ å„ç§å¸ƒå±€ç»„ä»¶çš„ä½¿ç”¨æ–¹æ³•',
        x: 120,
        y: 250,
        connections: ['node8'],
        completed: false
      },
      {
        id: 'node8',
        title: 'é¡¹ç›®å®žæˆ˜',
        description: 'å®Œæˆä¸€ä¸ªå®Œæ•´çš„HarmonyOSåº”ç”¨é¡¹ç›®',
        x: 200,
        y: 350,
        connections: [],
        completed: false
      }
    ];
  }

  initializeVideoProgresses() {
    this.videoProgresses = [
      {
        videoId: 'video1',
        currentTime: 900, // 15åˆ†é’Ÿ
        totalTime: 1800, // 30åˆ†é’Ÿ
        watchedSegments: [
          { start: 0, end: 600 },
          { start: 700, end: 900 }
        ],
        completionRate: 50
      },
      {
        videoId: 'video2',
        currentTime: 0,
        totalTime: 2400, // 40åˆ†é’Ÿ
        watchedSegments: [],
        completionRate: 0
      },
      {
        videoId: 'video3',
        currentTime: 600, // 10åˆ†é’Ÿ
        totalTime: 3000, // 50åˆ†é’Ÿ
        watchedSegments: [
          { start: 0, end: 600 }
        ],
        completionRate: 20
      }
    ];
  }

  // åŠŸèƒ½æ–¹æ³•
  showNotifications() {
    console.log('æ˜¾ç¤ºé€šçŸ¥');
    // å®žçŽ°é€šçŸ¥åŠŸèƒ½
  }

  showSettings() {
    console.log('æ˜¾ç¤ºè®¾ç½®');
    // å®žçŽ°è®¾ç½®åŠŸèƒ½
  }

  // èŽ·å–å­¦ä¹ ç»Ÿè®¡æ•°æ®
  getLearningStats(): StudentStats {
    const completedTasks = this.tasks.filter(task => task.status === 'completed').length;
    const totalTasks = this.tasks.length;
    const averageProgress = this.tasks.reduce((sum, task) => sum + task.progress, 0) / totalTasks;

    const completedQuizzes = this.quizzes.filter(quiz => quiz.bestScore > 0).length;
    const averageScore = this.quizzes.reduce((sum, quiz) => sum + quiz.bestScore, 0) / this.quizzes.length;

    const completedNodes = this.knowledgeNodes.filter(node => node.completed).length;
    const knowledgeProgress = (completedNodes / this.knowledgeNodes.length) * 100;

    const completedVideos = this.videoProgresses.filter(progress => progress.completionRate >= 100).length;
    const averageVideoProgress = this.videoProgresses.reduce((sum, progress) => sum + progress.completionRate, 0) / this.videoProgresses.length;

    return {
      tasks: { completed: completedTasks, total: totalTasks, averageProgress: averageProgress },
      quizzes: { completed: completedQuizzes, total: this.quizzes.length, averageScore: averageScore },
      knowledge: { completed: completedNodes, total: this.knowledgeNodes.length, progress: knowledgeProgress },
      videos: { completed: completedVideos, total: this.videoProgresses.length, averageProgress: averageVideoProgress }
    } as StudentStats;
  }
}