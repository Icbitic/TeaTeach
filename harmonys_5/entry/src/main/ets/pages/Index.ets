import { router } from '@kit.ArkUI';

interface User {
  username: string;
  password: string;
}

let userDB: User[] = [
  { username: 'test', password: '123456' }
];

@Entry
@Component
struct LoginPage {
  @State username: string = '';
  @State password: string = '';
  @State errorMsg: string = '';
  @State isLoading: boolean = false;
  @State showPassword: boolean = false;
  @State userType: string = 'student'; // 'student' æˆ– 'teacher'

  build(): void {
    Stack() {
      // èƒŒæ™¯æ¸å˜
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 135,
          colors: [['#667eea', 0], ['#764ba2', 1]]
        });

      // ä½¿ç”¨æ»šåŠ¨å®¹å™¨ç¡®ä¿å†…å®¹ä¸è¢«é®æŒ¡
      Scroll() {
        Column({ space: 0 }) {
          // é¡¶éƒ¨è£…é¥°åŒºåŸŸ
          Column({ space: 16 }) {
            // LogoåŒºåŸŸ
            Column() {
              Text('ğŸ“')
                .fontSize(56)
                .fontColor('#ffffff')
                .textAlign(TextAlign.Center);
            }
            .width(100)
            .height(100)
            .backgroundColor('#ffffff20')
            .borderRadius(50)
            .justifyContent(FlexAlign.Center)
            .shadow({ radius: 20, color: '#00000030', offsetX: 0, offsetY: 10 });

            Text('æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿ')
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor('#ffffff')
              .textAlign(TextAlign.Center)
              .textShadow({ radius: 4, color: '#00000040', offsetX: 0, offsetY: 2 });

            Text('è®©å­¦ä¹ æ›´é«˜æ•ˆï¼Œè®©ç®¡ç†æ›´ç®€å•')
              .fontSize(14)
              .fontColor('#ffffff')
              .opacity(0.9)
              .textAlign(TextAlign.Center);
          }
          .margin({ top: 40, bottom: 30 });

          // ç™»å½•å¡ç‰‡
          Column({ space: 24 }) {
            Text('æ¬¢è¿å›æ¥')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1f2937')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 8 });

            // ç”¨æˆ·ç±»å‹é€‰æ‹©
            Column({ space: 12 }) {
              Text('é€‰æ‹©èº«ä»½')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .fontColor('#374151')
                .alignSelf(ItemAlign.Start);

              Row({ space: 0 }) {
                Button('ğŸ‘¨â€ğŸ“ å­¦ç”Ÿ')
                  .backgroundColor(this.userType === 'student' ? '#6366f1' : '#f8fafc')
                  .fontColor(this.userType === 'student' ? '#ffffff' : '#6b7280')
                  .borderRadius({ topLeft: 12, bottomLeft: 12, topRight: 0, bottomRight: 0 })
                  .border({ width: 1, color: this.userType === 'student' ? '#6366f1' : '#e5e7eb' })
                  .layoutWeight(1)
                  .padding({ top: 14, bottom: 14 })
                  .onClick(() => {
                    this.userType = 'student';
                  });

                Button('ğŸ‘¨â€ğŸ« æ•™å¸ˆ')
                  .backgroundColor(this.userType === 'teacher' ? '#6366f1' : '#f8fafc')
                  .fontColor(this.userType === 'teacher' ? '#ffffff' : '#6b7280')
                  .borderRadius({ topLeft: 0, bottomLeft: 0, topRight: 12, bottomRight: 12 })
                  .border({ width: 1, color: this.userType === 'teacher' ? '#6366f1' : '#e5e7eb' })
                  .layoutWeight(1)
                  .padding({ top: 14, bottom: 14 })
                  .onClick(() => {
                    this.userType = 'teacher';
                  });
              }
              .width('100%');
            }

            // ç”¨æˆ·åè¾“å…¥æ¡†
            Column({ space: 8 }) {
              Row({ space: 12 }) {
                Text('ğŸ‘¤')
                  .fontSize(20)
                  .fontColor('#6b7280');

                TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å', text: this.username })
                  .onChange((val: string) => this.username = val)
                  .fontSize(16)
                  .backgroundColor('transparent')
                  .border({ width: 0 })
                  .layoutWeight(1)
                  .placeholderColor('#9ca3af')
                  .fontColor('#1f2937');
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 14, bottom: 14 })
              .backgroundColor('#f8fafc')
              .borderRadius(12)
              .border({ width: 1, color: '#e2e8f0' });
            }

            // å¯†ç è¾“å…¥æ¡†
            Column({ space: 8 }) {
              Row({ space: 12 }) {
                Text('ğŸ”’')
                  .fontSize(20)
                  .fontColor('#6b7280');

                TextInput({
                  placeholder: 'è¯·è¾“å…¥å¯†ç ',
                  text: this.password
                })
                  .onChange((val: string) => this.password = val)
                  .type(this.showPassword ? InputType.Normal : InputType.Password)
                  .fontSize(16)
                  .backgroundColor('transparent')
                  .border({ width: 0 })
                  .layoutWeight(1)
                  .placeholderColor('#9ca3af')
                  .fontColor('#1f2937');

                Button(this.showPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸')
                  .backgroundColor('transparent')
                  .fontSize(18)
                  .fontColor('#6b7280')
                  .padding(0)
                  .width(32)
                  .height(32)
                  .onClick(() => {
                    this.showPassword = !this.showPassword;
                  });
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 14, bottom: 14 })
              .backgroundColor('#f8fafc')
              .borderRadius(12)
              .border({ width: 1, color: '#e2e8f0' });
            }

            // é”™è¯¯ä¿¡æ¯
            if (this.errorMsg !== '') {
              Row({ space: 8 }) {
                Text('âš ï¸')
                  .fontSize(16);

                Text(this.errorMsg)
                  .fontSize(14)
                  .fontColor('#ef4444')
                  .flexGrow(1);
              }
              .width('100%')
              .padding(12)
              .backgroundColor('#fef2f2')
              .borderRadius(8)
              .border({ width: 1, color: '#fecaca' });
            }

            // ç™»å½•æŒ‰é’®
            Button(this.isLoading ? 'ç™»å½•ä¸­...' : `ğŸš€ ${this.userType === 'student' ? 'å­¦ç”Ÿ' : 'æ•™å¸ˆ'}ç™»å½•`)
              .width('100%')
              .height(52)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#ffffff')
              .backgroundColor(this.isLoading ? '#9ca3af' : (this.userType === 'student' ? '#3b82f6' : '#10b981'))
              .borderRadius(12)
              .shadow({ radius: 8, color: this.userType === 'student' ? '#3b82f630' : '#10b98130', offsetX: 0, offsetY: 4 })
              .enabled(!this.isLoading)
              .onClick(() => {
                if (this.username === '' || this.password === '') {
                  this.errorMsg = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                  return;
                }

                this.isLoading = true;
                this.errorMsg = '';

                // æ¨¡æ‹Ÿç™»å½•å»¶è¿Ÿ
                setTimeout(() => {
                  let match = userDB.find(u => u.username === this.username && u.password === this.password);
                  if (match) {
                    // æ ¹æ®ç”¨æˆ·ç±»å‹è·³è½¬åˆ°ä¸åŒé¡µé¢
                    if (this.userType === 'student') {
                      router.pushUrl({ url: 'pages/student/student' }).catch((err: Error) => {
                        console.error('Navigation failed:', err.message);
                      }); // å­¦ç”Ÿä¸»é¡µ
                    } else {
                      router.pushUrl({ url: 'pages/teacher/teacher' }).catch((err: Error) => {
                        console.error('Navigation failed:', err.message);
                      }); // æ•™å¸ˆä¸»é¡µ
                    }
                  } else {
                    this.errorMsg = `${this.userType === 'student' ? 'å­¦ç”Ÿ' : 'æ•™å¸ˆ'}ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•`;
                  }
                  this.isLoading = false;
                }, 1000);
              });

            // åˆ†å‰²çº¿
            Row({ space: 16 }) {
              Divider()
                .strokeWidth(1)
                .color('#e2e8f0')
                .layoutWeight(1);

              Text('æˆ–')
                .fontSize(14)
                .fontColor('#6b7280');

              Divider()
                .strokeWidth(1)
                .color('#e2e8f0')
                .layoutWeight(1);
            }
            .width('100%');

            // æ³¨å†ŒæŒ‰é’®
            Button(`ğŸ“ åˆ›å»º${this.userType === 'student' ? 'å­¦ç”Ÿ' : 'æ•™å¸ˆ'}è´¦æˆ·`)
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor(this.userType === 'student' ? '#3b82f6' : '#10b981')
              .backgroundColor('#ffffff')
              .borderRadius(12)
              .border({ width: 2, color: this.userType === 'student' ? '#3b82f6' : '#10b981' })
              .shadow({ radius: 4, color: this.userType === 'student' ? '#3b82f620' : '#10b98120', offsetX: 0, offsetY: 2 })
              .onClick(() => {
                router.pushUrl({
              url: 'pages/RegisterPage'
            }).catch((err: Error) => {
              console.error('Navigation failed:', err.message);
            });
              });

            // åº•éƒ¨æç¤º
            Text('ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„æœåŠ¡æ¡æ¬¾å’Œéšç§æ”¿ç­–')
              .fontSize(12)
              .fontColor('#6b7280')
              .textAlign(TextAlign.Center)
              .lineHeight(18)
              .margin({ top: 16 });
          }
          .width('100%')
          .padding(24)
          .backgroundColor('#ffffff')
          .borderRadius(24)
          .shadow({ radius: 30, color: '#00000020', offsetX: 0, offsetY: 15 })
          .margin({ left: 20, right: 20, bottom: 40 });
        }
        .width('100%')
        .padding({ left: 0, right: 0, top: 20, bottom: 40 });
      }
      .width('100%')
      .height('100%')
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring);
    }
    .width('100%')
    .height('100%');
  }
}