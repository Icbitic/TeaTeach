import { QuestionBank } from '../interfaces/TeacherInterfaces';

@Component
export struct QuestionBankManagement {
  @Link questionBank: QuestionBank[];
  @State showQuestionDialog: boolean = false;
  @State newQuestionSubject: string = '';
  @State newQuestionDifficulty: string = 'easy';
  @State newQuestionType: string = 'choice';
  @State newQuestionContent: string = '';
  @State newQuestionOptions: string[] = ['', '', '', ''];
  @State newQuestionAnswer: string = '';
  @State newQuestionKnowledgePoints: string = '';
  @State searchText: string = '';
  @State selectedDifficulty: string = 'å…¨éƒ¨';
  @State selectedType: string = 'å…¨éƒ¨';

  private difficulties: string[] = ['å…¨éƒ¨', 'easy', 'medium', 'hard'];
  private questionTypes: string[] = ['å…¨éƒ¨', 'choice', 'multiple', 'short_answer', 'programming'];

  build() {
    Column({ space: 20 }) {
      // é¢˜åº“ç®¡ç†æ ‡é¢˜å’Œæ“ä½œ
      Row({ space: 16 }) {
        Text('ðŸ“š é¢˜åº“ç®¡ç†')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1e293b')
          .layoutWeight(1);

        Button('âž• æ–°å»ºé¢˜ç›®')
          .backgroundColor('#10b981')
          .fontColor(Color.White)
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .onClick(() => {
            this.showQuestionDialog = true;
          });
      }

      // æœç´¢å’Œç­›é€‰
      Row({ space: 12 }) {
        TextInput({ placeholder: 'ðŸ” æœç´¢é¢˜ç›®...', text: this.searchText })
          .onChange(v => this.searchText = v)
          .layoutWeight(1)
          .backgroundColor('#ffffff')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 });

        Button('å¯¼å…¥é¢˜ç›®')
          .backgroundColor('#f1f5f9')
          .fontColor('#64748b')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
          .onClick(() => {
            this.importQuestions();
          });
      }

      // éš¾åº¦ç­›é€‰
      Row({ space: 8 }) {
        Text('éš¾åº¦ï¼š')
          .fontSize(14)
          .fontColor('#6b7280');
        
        ForEach(this.difficulties, (difficulty: string) => {
          Button(this.getDifficultyText(difficulty))
            .backgroundColor(this.selectedDifficulty === difficulty ? '#6366f1' : '#ffffff')
            .fontColor(this.selectedDifficulty === difficulty ? Color.White : '#6b7280')
            .borderRadius(20)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .fontSize(14)
            .border({ width: 1, color: this.selectedDifficulty === difficulty ? '#6366f1' : '#e5e7eb' })
            .onClick(() => {
              this.selectedDifficulty = difficulty;
            });
        });
      }

      // é¢˜åž‹ç­›é€‰
      Row({ space: 8 }) {
        Text('é¢˜åž‹ï¼š')
          .fontSize(14)
          .fontColor('#6b7280');
        
        ForEach(this.questionTypes, (type: string) => {
          Button(this.getTypeText(type))
            .backgroundColor(this.selectedType === type ? '#6366f1' : '#ffffff')
            .fontColor(this.selectedType === type ? Color.White : '#6b7280')
            .borderRadius(20)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .fontSize(14)
            .border({ width: 1, color: this.selectedType === type ? '#6366f1' : '#e5e7eb' })
            .onClick(() => {
              this.selectedType = type;
            });
        });
      }

      // é¢˜ç›®åˆ—è¡¨
      ForEach(this.getFilteredQuestions(), (question: QuestionBank) => {
        this.buildQuestionCard(question);
      });

      // æ–°å»ºé¢˜ç›®å¯¹è¯æ¡†
      if (this.showQuestionDialog) {
        this.buildQuestionDialog();
      }
    }
    .width('100%')
    .padding(16);
  }

  @Builder
  buildQuestionCard(question: QuestionBank) {
    Column({ space: 12 }) {
      Row({ space: 12 }) {
        Column({ space: 4 }) {
          Row({ space: 8 }) {
            Text(this.getTypeIcon(question.type))
              .fontSize(16);
            
            Text(question.subject)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1e293b');
          }

          Row({ space: 8 }) {
            Text(this.getDifficultyText(question.difficulty))
              .fontSize(12)
              .fontColor(this.getDifficultyColor(question.difficulty))
              .backgroundColor(this.getDifficultyBgColor(question.difficulty))
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12);
            
            Text(`ä½¿ç”¨${question.usageCount}æ¬¡`)
              .fontSize(12)
              .fontColor('#6b7280')
              .backgroundColor('#f8fafc')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12);
          }
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1);

        Column({ space: 4 }) {
          Text(`${Math.round(question.successRate * 100)}%`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(question.successRate >= 0.8 ? '#10b981' : question.successRate >= 0.6 ? '#f59e0b' : '#ef4444');
          
          Text('æ­£ç¡®çŽ‡')
            .fontSize(12)
            .fontColor('#9ca3af');
        }
        .alignItems(HorizontalAlign.Center);
      }

      Text(question.question)
        .fontSize(15)
        .fontColor('#374151')
        .lineHeight(22)
        .maxLines(3)
        .textOverflow({ overflow: TextOverflow.Ellipsis });

      // é€‰é¡¹æ˜¾ç¤ºï¼ˆä»…å¯¹é€‰æ‹©é¢˜ï¼‰
      if (question.type === 'choice' || question.type === 'multiple') {
        Column({ space: 6 }) {
          ForEach(question.options, (option: string, index: number) => {
            if (option.trim() !== '') {
              Row({ space: 8 }) {
                Text(String.fromCharCode(65 + index) + '.')
                  .fontSize(14)
                  .fontColor('#6b7280')
                  .width(20);
                
                Text(option)
                  .fontSize(14)
                  .fontColor('#374151')
                  .layoutWeight(1);
              }
            }
          });
        }
        .alignItems(HorizontalAlign.Start)
        .width('100%')
        .padding({ left: 12, top: 8, bottom: 8 })
        .backgroundColor('#f8fafc')
        .borderRadius(8);
      }

      // çŸ¥è¯†ç‚¹æ ‡ç­¾
      if (question.knowledgePoints.length > 0) {
        Row({ space: 6 }) {
          Text('ðŸ·ï¸')
            .fontSize(12);
          
          ForEach(question.knowledgePoints.slice(0, 3), (point: string) => {
            Text(point)
              .fontSize(12)
              .fontColor('#6366f1')
              .backgroundColor('#eef2ff')
              .padding({ left: 6, right: 6, top: 2, bottom: 2 })
              .borderRadius(8);
          });
          
          if (question.knowledgePoints.length > 3) {
            Text(`+${question.knowledgePoints.length - 3}`)
              .fontSize(12)
              .fontColor('#9ca3af');
          }
        }
      }

      Row({ space: 12 }) {
        Blank();

        Button('ç¼–è¾‘')
          .backgroundColor('#f59e0b')
          .fontColor(Color.White)
          .borderRadius(6)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .fontSize(12)
          .onClick(() => {
            this.editQuestion(question);
          });

        Button('åˆ é™¤')
          .backgroundColor('#ef4444')
          .fontColor(Color.White)
          .borderRadius(6)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .fontSize(12)
          .onClick(() => {
            this.deleteQuestion(question.id);
          });
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 });
  }

  @Builder
  buildQuestionDialog() {
    Column({ space: 16 }) {
      Text('æ–°å»ºé¢˜ç›®')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1e293b');

      Row({ space: 12 }) {
        Column({ space: 4 }) {
          Text('å­¦ç§‘')
            .fontSize(14)
            .fontColor('#374151');
          
          TextInput({ placeholder: 'å¦‚ï¼šHarmonyOSå¼€å‘', text: this.newQuestionSubject })
            .onChange(v => this.newQuestionSubject = v)
            .backgroundColor('#f8fafc')
            .borderRadius(8)
            .padding(8);
        }
        .layoutWeight(1);

        Column({ space: 4 }) {
          Text('éš¾åº¦')
            .fontSize(14)
            .fontColor('#374151');
          
          Button(this.getDifficultyText(this.newQuestionDifficulty))
            .backgroundColor('#f8fafc')
            .fontColor('#374151')
            .borderRadius(8)
            .padding(8)
            .onClick(() => {
              this.showDifficultySelector();
            });
        }
        .layoutWeight(1);
      }

      Column({ space: 8 }) {
        Text('é¢˜åž‹')
          .fontSize(14)
          .fontColor('#374151')
          .alignSelf(ItemAlign.Start);
        
        Row({ space: 8 }) {
          Button('å•é€‰é¢˜')
            .backgroundColor(this.newQuestionType === 'choice' ? '#6366f1' : '#f8fafc')
            .fontColor(this.newQuestionType === 'choice' ? Color.White : '#374151')
            .borderRadius(8)
            .padding({ left: 12, right: 12, top: 8, bottom: 8 })
            .fontSize(14)
            .onClick(() => {
              this.newQuestionType = 'choice';
            });
          
          Button('å¤šé€‰é¢˜')
            .backgroundColor(this.newQuestionType === 'multiple' ? '#6366f1' : '#f8fafc')
            .fontColor(this.newQuestionType === 'multiple' ? Color.White : '#374151')
            .borderRadius(8)
            .padding({ left: 12, right: 12, top: 8, bottom: 8 })
            .fontSize(14)
            .onClick(() => {
              this.newQuestionType = 'multiple';
            });
          
          Button('ç®€ç­”é¢˜')
            .backgroundColor(this.newQuestionType === 'short_answer' ? '#6366f1' : '#f8fafc')
            .fontColor(this.newQuestionType === 'short_answer' ? Color.White : '#374151')
            .borderRadius(8)
            .padding({ left: 12, right: 12, top: 8, bottom: 8 })
            .fontSize(14)
            .onClick(() => {
              this.newQuestionType = 'short_answer';
            });
        }
      }

      TextArea({ placeholder: 'è¯·è¾“å…¥é¢˜ç›®å†…å®¹...', text: this.newQuestionContent })
        .onChange(v => this.newQuestionContent = v)
        .backgroundColor('#f8fafc')
        .borderRadius(8)
        .padding(12)
        .height(80);

      // é€‰æ‹©é¢˜é€‰é¡¹
      if (this.newQuestionType === 'choice' || this.newQuestionType === 'multiple') {
        Column({ space: 8 }) {
          Text('é€‰é¡¹è®¾ç½®')
            .fontSize(14)
            .fontColor('#374151')
            .alignSelf(ItemAlign.Start);
          
          ForEach([0, 1, 2, 3], (index: number) => {
            Row({ space: 8 }) {
              Text(String.fromCharCode(65 + index) + '.')
                .fontSize(14)
                .fontColor('#6b7280')
                .width(20);
              
              TextInput({ placeholder: `é€‰é¡¹${String.fromCharCode(65 + index)}`, text: this.newQuestionOptions[index] })
                .onChange(v => {
                  this.newQuestionOptions[index] = v;
                })
                .backgroundColor('#f8fafc')
                .borderRadius(8)
                .padding(8)
                .layoutWeight(1);
            }
          });
        }
      }

      TextInput({ placeholder: 'æ­£ç¡®ç­”æ¡ˆ', text: this.newQuestionAnswer })
        .onChange(v => this.newQuestionAnswer = v)
        .backgroundColor('#f8fafc')
        .borderRadius(8)
        .padding(12);

      TextInput({ placeholder: 'çŸ¥è¯†ç‚¹ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰', text: this.newQuestionKnowledgePoints })
        .onChange(v => this.newQuestionKnowledgePoints = v)
        .backgroundColor('#f8fafc')
        .borderRadius(8)
        .padding(12);

      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .backgroundColor('#f3f4f6')
          .fontColor('#6b7280')
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .layoutWeight(1)
          .onClick(() => {
            this.showQuestionDialog = false;
            this.resetQuestionForm();
          });

        Button('ç¡®å®š')
          .backgroundColor('#6366f1')
          .fontColor(Color.White)
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .layoutWeight(1)
          .onClick(() => {
            this.addNewQuestion();
          });
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 4 });
  }

  // åŠŸèƒ½æ–¹æ³•
  getFilteredQuestions(): QuestionBank[] {
    return this.questionBank.filter(question => {
      const matchesSearch = question.question.toLowerCase().includes(this.searchText.toLowerCase()) ||
                           question.subject.toLowerCase().includes(this.searchText.toLowerCase());
      const matchesDifficulty = this.selectedDifficulty === 'å…¨éƒ¨' || question.difficulty === this.selectedDifficulty;
      const matchesType = this.selectedType === 'å…¨éƒ¨' || question.type === this.selectedType;
      return matchesSearch && matchesDifficulty && matchesType;
    });
  }

  getDifficultyText(difficulty: string): string {
    switch (difficulty) {
      case 'easy': return 'ç®€å•';
      case 'medium': return 'ä¸­ç­‰';
      case 'hard': return 'å›°éš¾';
      case 'å…¨éƒ¨': return 'å…¨éƒ¨';
      default: return difficulty;
    }
  }

  getDifficultyColor(difficulty: string): string {
    switch (difficulty) {
      case 'easy': return '#10b981';
      case 'medium': return '#f59e0b';
      case 'hard': return '#ef4444';
      default: return '#6b7280';
    }
  }

  getDifficultyBgColor(difficulty: string): string {
    switch (difficulty) {
      case 'easy': return '#ecfdf5';
      case 'medium': return '#fef3c7';
      case 'hard': return '#fee2e2';
      default: return '#f8fafc';
    }
  }

  getTypeText(type: string): string {
    switch (type) {
      case 'choice': return 'å•é€‰é¢˜';
      case 'multiple': return 'å¤šé€‰é¢˜';
      case 'short_answer': return 'ç®€ç­”é¢˜';
      case 'programming': return 'ç¼–ç¨‹é¢˜';
      case 'å…¨éƒ¨': return 'å…¨éƒ¨';
      default: return type;
    }
  }

  getTypeIcon(type: string): string {
    switch (type) {
      case 'choice': return 'ðŸ”˜';
      case 'multiple': return 'â˜‘ï¸';
      case 'short_answer': return 'ðŸ“';
      case 'programming': return 'ðŸ’»';
      default: return 'â“';
    }
  }

  editQuestion(question: QuestionBank) {
    this.newQuestionSubject = question.subject;
    this.newQuestionDifficulty = question.difficulty;
    this.newQuestionType = question.type;
    this.newQuestionContent = question.question;
    this.newQuestionOptions = [...question.options];
    this.newQuestionAnswer = Array.isArray(question.correctAnswer) ? 
      question.correctAnswer.join(', ') : question.correctAnswer;
    this.newQuestionKnowledgePoints = question.knowledgePoints.join(', ');
    this.showQuestionDialog = true;
  }

  deleteQuestion(questionId: string) {
    this.questionBank = this.questionBank.filter(question => question.id !== questionId);
  }

  importQuestions() {
    console.log('å¯¼å…¥é¢˜ç›®');
    // å®žçŽ°é¢˜ç›®å¯¼å…¥åŠŸèƒ½
  }

  showDifficultySelector() {
    console.log('æ˜¾ç¤ºéš¾åº¦é€‰æ‹©å™¨');
    // å®žçŽ°éš¾åº¦é€‰æ‹©å¯¹è¯æ¡†
  }

  addNewQuestion() {
    if (this.newQuestionContent.trim() === '') {
      return;
    }

    const newQuestion: QuestionBank = {
      id: Date.now().toString(),
      subject: this.newQuestionSubject,
      difficulty: this.newQuestionDifficulty,
      type: this.newQuestionType,
      question: this.newQuestionContent,
      options: this.newQuestionOptions.filter(option => option.trim() !== ''),
      correctAnswer: this.newQuestionAnswer,
      knowledgePoints: this.newQuestionKnowledgePoints.split(',').map(k => k.trim()).filter(k => k !== ''),
      usageCount: 0,
      successRate: 0
    };

    this.questionBank.push(newQuestion);
    this.resetQuestionForm();
    this.showQuestionDialog = false;
  }

  resetQuestionForm() {
    this.newQuestionContent = '';
    this.newQuestionSubject = '';
    this.newQuestionDifficulty = 'easy';
    this.newQuestionType = 'choice';
    this.newQuestionOptions = ['', '', '', ''];
    this.newQuestionAnswer = '';
    this.newQuestionKnowledgePoints = '';
  }
}