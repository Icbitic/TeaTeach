import { router } from '@kit.ArkUI';
import { Analytics, ActivityLog } from '../interfaces/TeacherInterfaces';

@Component
export struct AnalyticsOverview {
  @Link analytics: Analytics;

  build() {
    Column({ space: 20 }) {
      // æ•°æ®æ¦‚è§ˆæ ‡é¢˜
      Row({ space: 16 }) {
        Text('ðŸ“Š æ•°æ®æ¦‚è§ˆ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1e293b')
          .layoutWeight(1);

        Button('ðŸ“ˆ è¯¦ç»†æŠ¥å‘Š')
          .backgroundColor('#6366f1')
          .fontColor(Color.White)
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .onClick(() => {
            router.pushUrl({ url: 'pages/DataPage' }).catch((err: Error) => {
              console.error('Navigation failed:', err.message);
            });
          });
      }

      // ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼
      Grid() {
        GridItem() {
          this.buildStatCard('ðŸ‘¥', 'å­¦ç”Ÿæ€»æ•°', this.analytics.totalStudents.toString(), '#10b981');
        }
        
        GridItem() {
          this.buildStatCard('ðŸ“š', 'æ´»è·ƒè¯¾ç¨‹', this.analytics.activeCourses.toString(), '#6366f1');
        }
        
        GridItem() {
          this.buildStatCard('ðŸ“', 'å¾…æ‰¹æ”¹', this.analytics.pendingGrading.toString(), '#f59e0b');
        }
        
        GridItem() {
          this.buildStatCard('ðŸ“ˆ', 'å¹³å‡å®ŒæˆçŽ‡', `${Math.round(this.analytics.averageCompletion * 100)}%`, '#8b5cf6');
        }
      }
      .columnsTemplate('1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .columnsGap(16)
      .rowsGap(16)
      .height(200);

      // æœ€è¿‘æ´»åŠ¨
      this.buildRecentActivity();

      // å¿«é€Ÿæ“ä½œ
      this.buildQuickActions();
    }
    .width('100%')
    .padding(16);
  }

  @Builder
  buildStatCard(icon: string, title: string, value: string, color: string) {
    Column({ space: 8 }) {
      Row({ space: 8 }) {
        Text(icon)
          .fontSize(24);
        
        Blank();
        
        Text(value)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(color);
      }
      .width('100%');

      Text(title)
        .fontSize(14)
        .fontColor('#6b7280')
        .width('100%')
        .textAlign(TextAlign.Start);
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
    .border({ width: 1, color: '#f3f4f6' });
  }

  @Builder
  buildRecentActivity() {
    Column({ space: 16 }) {
      Row({ space: 12 }) {
        Text('ðŸ•’ æœ€è¿‘æ´»åŠ¨')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1e293b')
          .layoutWeight(1);

        Button('æŸ¥çœ‹å…¨éƒ¨')
          .backgroundColor('transparent')
          .fontColor('#6366f1')
          .fontSize(14)
          .padding({ left: 8, right: 8, top: 4, bottom: 4 });
      }

      Column({ space: 12 }) {
        if (this.analytics.recentActivity.length === 0) {
          Column({ space: 8 }) {
            Text('ðŸ“­')
              .fontSize(48)
              .fontColor('#d1d5db');
            
            Text('æš‚æ— æœ€è¿‘æ´»åŠ¨')
              .fontSize(16)
              .fontColor('#9ca3af');
          }
          .width('100%')
          .padding(32)
          .justifyContent(FlexAlign.Center);
        } else {
          ForEach(this.analytics.recentActivity.slice(0, 5), (activity: ActivityLog) => {
            this.buildActivityItem(activity);
          });
        }
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 });
  }

  @Builder
  buildActivityItem(activity: ActivityLog) {
    Row({ space: 12 }) {
      Text(this.getActivityIcon(activity.type))
        .fontSize(20)
        .width(32)
        .textAlign(TextAlign.Center);

      Column({ space: 4 }) {
        Text(activity.description)
          .fontSize(15)
          .fontColor('#374151')
          .fontWeight(FontWeight.Medium);
        
        Row({ space: 8 }) {
          Text(activity.studentName)
            .fontSize(13)
            .fontColor('#6366f1')
            .backgroundColor('#eef2ff')
            .padding({ left: 6, right: 6, top: 2, bottom: 2 })
            .borderRadius(8);
          
          Text(this.formatTime(activity.timestamp))
            .fontSize(13)
            .fontColor('#9ca3af');
        }
      }
      .alignItems(HorizontalAlign.Start)
      .layoutWeight(1);
    }
    .width('100%')
    .padding({ left: 8, right: 8, top: 12, bottom: 12 })
    .backgroundColor('#f8fafc')
    .borderRadius(8);
  }

  @Builder
  buildQuickActions() {
    Column({ space: 16 }) {
      Text('âš¡ å¿«é€Ÿæ“ä½œ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1e293b')
        .width('100%')
        .textAlign(TextAlign.Start);

      Grid() {
        GridItem() {
          this.buildActionCard('ðŸ“š', 'æ–°å»ºè¯¾ç¨‹', '#10b981', () => {
            this.createNewCourse();
          });
        }
        
        GridItem() {
          this.buildActionCard('ðŸ“', 'å‘å¸ƒä½œä¸š', '#6366f1', () => {
            this.createNewAssignment();
          });
        }
        
        GridItem() {
          this.buildActionCard('â“', 'æ·»åŠ é¢˜ç›®', '#f59e0b', () => {
            this.addNewQuestion();
          });
        }
        
        GridItem() {
          this.buildActionCard('ðŸ‘¥', 'å­¦ç”Ÿç®¡ç†', '#8b5cf6', () => {
            this.manageStudents();
          });
        }
      }
      .columnsTemplate('1fr 1fr')
      .rowsTemplate('1fr 1fr')
      .columnsGap(12)
      .rowsGap(12)
      .height(160);
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 });
  }

  @Builder
  buildActionCard(icon: string, title: string, color: string, action: () => void) {
    Column({ space: 8 }) {
      Text(icon)
        .fontSize(32)
        .fontColor(color);
      
      Text(title)
        .fontSize(14)
        .fontColor('#374151')
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center);
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .border({ width: 2, color: color })
    .onClick(() => {
      action();
    });
  }

  // å·¥å…·æ–¹æ³•
  getActivityIcon(type: string): string {
    switch (type) {
      case 'submission': return 'ðŸ“¤';
      case 'completion': return 'âœ…';
      case 'login': return 'ðŸ”‘';
      case 'quiz': return 'ðŸ“‹';
      case 'discussion': return 'ðŸ’¬';
      default: return 'ðŸ“Œ';
    }
  }

  formatTime(timestamp: string): string {
    const now = new Date();
    const time = new Date(timestamp);
    const diffMs = now.getTime() - time.getTime();
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffMins < 1) {
      return 'åˆšåˆš';
    } else if (diffMins < 60) {
      return `${diffMins}åˆ†é’Ÿå‰`;
    } else if (diffHours < 24) {
      return `${diffHours}å°æ—¶å‰`;
    } else if (diffDays < 7) {
      return `${diffDays}å¤©å‰`;
    } else {
      return time.toLocaleDateString();
    }
  }

  // å¿«é€Ÿæ“ä½œæ–¹æ³•
  createNewCourse() {
    console.log('åˆ›å»ºæ–°è¯¾ç¨‹');
    // è§¦å‘çˆ¶ç»„ä»¶çš„æ–°å»ºè¯¾ç¨‹æ“ä½œ
  }

  createNewAssignment() {
    console.log('å‘å¸ƒæ–°ä½œä¸š');
    // è§¦å‘çˆ¶ç»„ä»¶çš„æ–°å»ºä½œä¸šæ“ä½œ
  }

  addNewQuestion() {
    console.log('æ·»åŠ æ–°é¢˜ç›®');
    // è§¦å‘çˆ¶ç»„ä»¶çš„æ–°å»ºé¢˜ç›®æ“ä½œ
  }

  manageStudents() {
    console.log('ç®¡ç†å­¦ç”Ÿ');
    // åˆ‡æ¢åˆ°å­¦ç”Ÿç®¡ç†æ ‡ç­¾é¡µ
  }
}