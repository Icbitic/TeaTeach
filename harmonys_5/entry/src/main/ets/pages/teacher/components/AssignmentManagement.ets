import { router } from '@kit.ArkUI';
import { Assignment, Course, AssignmentType } from '../interfaces/TeacherInterfaces';

@Component
export struct AssignmentManagement {
  @Link assignments: Assignment[];
  @Link courses: Course[];
  @State showAssignmentDialog: boolean = false;
  @State newAssignmentTitle: string = '';
  @State newAssignmentDescription: string = '';
  @State newAssignmentType: string = 'homework';
  @State newAssignmentDeadline: string = '';
  @State newAssignmentPoints: number = 100;
  @State selectedAssignmentCourse: string = '';
  @State searchText: string = '';
  @State selectedType: string = 'å…¨éƒ¨';

  private assignmentTypes: AssignmentType[] = [
    { value: 'homework', label: 'ğŸ“ ç« èŠ‚ä½œä¸š' },
    { value: 'exam', label: 'ğŸ“‹ è¯•å·ç­”é¢˜' },
    { value: 'video', label: 'ğŸ¥ è¯¾ç¨‹è§†é¢‘è§‚çœ‹' },
    { value: 'reading', label: 'ğŸ“š é˜…è¯»æ•™æ/PPT' },
    { value: 'project', label: 'ğŸ“„ æŠ¥å‘Šç±»æ–‡æ¡£ä¸Šä¼ ' }
  ];

  build() {
    Column({ space: 20 }) {
      // ä½œä¸šç®¡ç†æ ‡é¢˜å’Œæ“ä½œ
      Row({ space: 16 }) {
        Text('ğŸ“ ä½œä¸šç®¡ç†')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1e293b')
          .layoutWeight(1);

        Button('â• æ–°å»ºä½œä¸š')
          .backgroundColor('#10b981')
          .fontColor(Color.White)
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .onClick(() => {
            this.showAssignmentDialog = true;
          });
      }

      // æœç´¢å’Œç­›é€‰
      Row({ space: 12 }) {
        TextInput({ placeholder: 'ğŸ” æœç´¢ä½œä¸š...', text: this.searchText })
          .onChange(v => this.searchText = v)
          .layoutWeight(1)
          .backgroundColor('#ffffff')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 });

        Button('ç­›é€‰')
          .backgroundColor('#f1f5f9')
          .fontColor('#64748b')
          .borderRadius(8)
          .padding({ left: 12, right: 12, top: 8, bottom: 8 });
      }

      // ä½œä¸šç±»å‹ç­›é€‰
      Scroll() {
        Row({ space: 8 }) {
          Button('å…¨éƒ¨')
            .backgroundColor(this.selectedType === 'å…¨éƒ¨' ? '#6366f1' : '#ffffff')
            .fontColor(this.selectedType === 'å…¨éƒ¨' ? Color.White : '#6b7280')
            .borderRadius(20)
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .fontSize(14)
            .border({ width: 1, color: this.selectedType === 'å…¨éƒ¨' ? '#6366f1' : '#e5e7eb' })
            .onClick(() => {
              this.selectedType = 'å…¨éƒ¨';
            });

          ForEach(this.assignmentTypes, (type: AssignmentType) => {
            Button(type.label)
              .backgroundColor(this.selectedType === type.value ? '#6366f1' : '#ffffff')
              .fontColor(this.selectedType === type.value ? Color.White : '#6b7280')
              .borderRadius(20)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .fontSize(14)
              .border({ width: 1, color: this.selectedType === type.value ? '#6366f1' : '#e5e7eb' })
              .onClick(() => {
                this.selectedType = type.value;
              });
          });
        }
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off);

      // ä½œä¸šåˆ—è¡¨
      ForEach(this.getFilteredAssignments(), (assignment: Assignment) => {
        this.buildAssignmentCard(assignment);
      });

      // æ–°å»ºä½œä¸šå¯¹è¯æ¡†
      if (this.showAssignmentDialog) {
        this.buildAssignmentDialog();
      }
    }
    .width('100%')
    .padding(16);
  }

  @Builder
  buildAssignmentCard(assignment: Assignment) {
    Column({ space: 12 }) {
      Row({ space: 12 }) {
        Column({ space: 4 }) {
          Text(assignment.title)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1e293b');

          Text(this.getAssignmentTypeLabel(assignment.type))
            .fontSize(14)
            .fontColor('#6366f1')
            .backgroundColor('#eef2ff')
            .padding({ left: 8, right: 8, top: 4, bottom: 4 })
            .borderRadius(12);
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1);

        Column({ space: 4 }) {
          Text(`${assignment.totalPoints}åˆ†`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1e293b');
          
          Text('æ€»åˆ†')
            .fontSize(12)
            .fontColor('#9ca3af');
        }
        .alignItems(HorizontalAlign.Center);
      }

      Text(assignment.description)
        .fontSize(14)
        .fontColor('#64748b')
        .maxLines(2)
        .textOverflow({ overflow: TextOverflow.Ellipsis });

      Row({ space: 16 }) {
        Column({ space: 4 }) {
          Text('ğŸ“… æˆªæ­¢æ—¶é—´')
            .fontSize(12)
            .fontColor('#9ca3af');
          
          Text(assignment.deadline)
            .fontSize(14)
            .fontColor('#374151');
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1);

        Column({ space: 4 }) {
          Text('ğŸ“Š æäº¤æƒ…å†µ')
            .fontSize(12)
            .fontColor('#9ca3af');
          
          Text(`${assignment.submissionCount}äººæäº¤`)
            .fontSize(14)
            .fontColor('#374151');
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1);

        Column({ space: 4 }) {
          Text('ğŸ“ˆ å¹³å‡åˆ†')
            .fontSize(12)
            .fontColor('#9ca3af');
          
          Text(`${assignment.averageScore}åˆ†`)
            .fontSize(14)
            .fontColor(assignment.averageScore >= 80 ? '#10b981' : assignment.averageScore >= 60 ? '#f59e0b' : '#ef4444');
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1);
      }

      Row({ space: 12 }) {
        Text(`ğŸ“š è¯¾ç¨‹ï¼š${this.getCourseName(assignment.courseId)}`)
          .fontSize(12)
          .fontColor('#9ca3af')
          .layoutWeight(1);

        Button('æŸ¥çœ‹è¯¦æƒ…')
          .backgroundColor('#6366f1')
          .fontColor(Color.White)
          .borderRadius(6)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .fontSize(12)
          .onClick(() => {
            this.viewAssignmentDetails(assignment);
          });

        Button('ç¼–è¾‘')
          .backgroundColor('#f59e0b')
          .fontColor(Color.White)
          .borderRadius(6)
          .padding({ left: 12, right: 12, top: 6, bottom: 6 })
          .fontSize(12)
          .onClick(() => {
            this.editAssignment(assignment);
          });
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 });
  }

  @Builder
  buildAssignmentDialog() {
    Column({ space: 16 }) {
      Text('æ–°å»ºä½œä¸š')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1e293b');

      TextInput({ placeholder: 'ä½œä¸šæ ‡é¢˜', text: this.newAssignmentTitle })
        .onChange(v => this.newAssignmentTitle = v)
        .backgroundColor('#f8fafc')
        .borderRadius(8)
        .padding(12);

      TextArea({ placeholder: 'ä½œä¸šæè¿°', text: this.newAssignmentDescription })
        .onChange(v => this.newAssignmentDescription = v)
        .backgroundColor('#f8fafc')
        .borderRadius(8)
        .padding(12)
        .height(80);

      // ä½œä¸šç±»å‹é€‰æ‹©
      Column({ space: 8 }) {
        Text('ä½œä¸šç±»å‹')
          .fontSize(14)
          .fontColor('#374151')
          .alignSelf(ItemAlign.Start);
        
        Scroll() {
          Row({ space: 8 }) {
            ForEach(this.assignmentTypes, (type: AssignmentType) => {
              Button(type.label)
                .backgroundColor(this.newAssignmentType === type.value ? '#6366f1' : '#f8fafc')
                .fontColor(this.newAssignmentType === type.value ? Color.White : '#374151')
                .borderRadius(8)
                .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                .fontSize(14)
                .onClick(() => {
                  this.newAssignmentType = type.value;
                });
            });
          }
        }
        .scrollable(ScrollDirection.Horizontal)
        .scrollBar(BarState.Off);
      }

      Row({ space: 12 }) {
        Column({ space: 4 }) {
          Text('æ‰€å±è¯¾ç¨‹')
            .fontSize(14)
            .fontColor('#374151');
          
          Button(this.getCourseName(this.selectedAssignmentCourse) || 'é€‰æ‹©è¯¾ç¨‹')
            .backgroundColor('#f8fafc')
            .fontColor('#374151')
            .borderRadius(8)
            .padding(8)
            .onClick(() => {
              this.showCourseSelector();
            });
        }
        .layoutWeight(1);

        Column({ space: 4 }) {
          Text('æ€»åˆ†')
            .fontSize(14)
            .fontColor('#374151');
          
          TextInput({ text: this.newAssignmentPoints.toString() })
            .onChange(v => this.newAssignmentPoints = parseInt(v) || 100)
            .backgroundColor('#f8fafc')
            .borderRadius(8)
            .padding(8)
            .type(InputType.Number);
        }
        .layoutWeight(1);
      }

      TextInput({ placeholder: 'æˆªæ­¢æ—¶é—´ (YYYY-MM-DD)', text: this.newAssignmentDeadline })
        .onChange(v => this.newAssignmentDeadline = v)
        .backgroundColor('#f8fafc')
        .borderRadius(8)
        .padding(12);

      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .backgroundColor('#f3f4f6')
          .fontColor('#6b7280')
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .layoutWeight(1)
          .onClick(() => {
            this.showAssignmentDialog = false;
            this.resetAssignmentForm();
          });

        Button('ç¡®å®š')
          .backgroundColor('#6366f1')
          .fontColor(Color.White)
          .borderRadius(8)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .layoutWeight(1)
          .onClick(() => {
            this.addNewAssignment();
          });
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 4 });
  }

  // åŠŸèƒ½æ–¹æ³•
  getFilteredAssignments(): Assignment[] {
    return this.assignments.filter(assignment => {
      const matchesSearch = assignment.title.toLowerCase().includes(this.searchText.toLowerCase()) ||
                           assignment.description.toLowerCase().includes(this.searchText.toLowerCase());
      const matchesType = this.selectedType === 'å…¨éƒ¨' || assignment.type === this.selectedType;
      return matchesSearch && matchesType;
    });
  }

  getAssignmentTypeLabel(type: string): string {
    const assignmentType = this.assignmentTypes.find(t => t.value === type);
    return assignmentType ? assignmentType.label : type;
  }

  getCourseName(courseId: string): string {
    const course = this.courses.find(c => c.id === courseId);
    return course ? course.name : 'æœªçŸ¥è¯¾ç¨‹';
  }

  viewAssignmentDetails(assignment: Assignment) {
    router.pushUrl({
      url: 'pages/TaskPage',
      params: {
        assignmentId: assignment.id,
        title: assignment.title
      }
    }).catch((err: Error) => {
      console.error('Navigation failed:', err.message);
    });
  }

  editAssignment(assignment: Assignment) {
    this.newAssignmentTitle = assignment.title;
    this.newAssignmentDescription = assignment.description;
    this.newAssignmentType = assignment.type;
    this.newAssignmentDeadline = assignment.deadline;
    this.newAssignmentPoints = assignment.totalPoints;
    this.selectedAssignmentCourse = assignment.courseId;
    this.showAssignmentDialog = true;
  }

  showCourseSelector() {
    console.log('æ˜¾ç¤ºè¯¾ç¨‹é€‰æ‹©å™¨');
    // å®ç°è¯¾ç¨‹é€‰æ‹©å¯¹è¯æ¡†
  }

  addNewAssignment() {
    if (this.newAssignmentTitle.trim() === '') {
      return;
    }

    const newAssignment: Assignment = {
      id: Date.now().toString(),
      title: this.newAssignmentTitle,
      courseId: this.selectedAssignmentCourse,
      type: this.newAssignmentType,
      description: this.newAssignmentDescription,
      deadline: this.newAssignmentDeadline,
      totalPoints: this.newAssignmentPoints,
      submissionCount: 0,
      averageScore: 0,
      status: 'è¿›è¡Œä¸­'
    };

    this.assignments.push(newAssignment);
    this.resetAssignmentForm();
    this.showAssignmentDialog = false;
  }

  resetAssignmentForm() {
    this.newAssignmentTitle = '';
    this.newAssignmentDescription = '';
    this.newAssignmentDeadline = '';
    this.newAssignmentPoints = 100;
    this.selectedAssignmentCourse = '';
    this.newAssignmentType = 'homework';
  }
}