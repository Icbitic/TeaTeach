import { router } from '@kit.ArkUI';

interface User {
  phone: string;
  password: string;
}

declare let userDB: User[]; // ä¸ loginPage å…±ç”¨æ•°æ®

@Entry
@Component
struct RegisterPage {
  @State phone: string = '';
  @State password: string = '';
  @State confirm: string = '';
  @State errorMsg: string = '';
  @State isLoading: boolean = false;
  @State showPassword: boolean = false;
  @State showConfirmPassword: boolean = false;

  build(): void {
    Stack() {
      // èƒŒæ™¯æ¸å˜
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          angle: 135,
          colors: [['#10b981', 0], ['#059669', 1]]
        });

      // ä½¿ç”¨æ»šåŠ¨å®¹å™¨ç¡®ä¿å†…å®¹ä¸è¢«é®æŒ¡
      Scroll() {
        Column({ space: 0 }) {
          // é¡¶éƒ¨è£…é¥°åŒºåŸŸ
          Column({ space: 16 }) {
            // LogoåŒºåŸŸ
            Column() {
              Text('ğŸ“')
                .fontSize(56)
                .fontColor('#ffffff')
                .textAlign(TextAlign.Center);
            }
            .width(100)
            .height(100)
            .backgroundColor('#ffffff20')
            .borderRadius(50)
            .justifyContent(FlexAlign.Center)
            .shadow({ radius: 20, color: '#00000030', offsetX: 0, offsetY: 10 });

            Text('ç”¨æˆ·æ³¨å†Œ')
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor('#ffffff')
              .textAlign(TextAlign.Center)
              .textShadow({ radius: 4, color: '#00000040', offsetX: 0, offsetY: 2 });

            Text('åŠ å…¥æˆ‘ä»¬ï¼Œå¼€å¯æ™ºèƒ½å­¦ä¹ ä¹‹æ—…')
              .fontSize(14)
              .fontColor('#ffffff')
              .opacity(0.9)
              .textAlign(TextAlign.Center);
          }
          .margin({ top: 40, bottom: 30 });

          // æ³¨å†Œå¡ç‰‡
          Column({ space: 24 }) {
            Text('åˆ›å»ºæ–°è´¦æˆ·')
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1f2937')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 8 });

            // æ‰‹æœºå·è¾“å…¥æ¡†
            Column({ space: 8 }) {
              Row({ space: 12 }) {
                Text('ğŸ“±')
                  .fontSize(20)
                  .fontColor('#6b7280');

                TextInput({ placeholder: 'è¯·è¾“å…¥æ‰‹æœºå·', text: this.phone })
                  .onChange((val: string) => this.phone = val)
                  .type(InputType.PhoneNumber)
                  .fontSize(16)
                  .backgroundColor('transparent')
                  .border({ width: 0 })
                  .layoutWeight(1)
                  .placeholderColor('#9ca3af')
                  .fontColor('#1f2937')
                  .maxLength(11);
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 14, bottom: 14 })
              .backgroundColor('#f8fafc')
              .borderRadius(12)
              .border({ width: 1, color: '#e2e8f0' });
            }

            // å¯†ç è¾“å…¥æ¡†
            Column({ space: 8 }) {
              Row({ space: 12 }) {
                Text('ğŸ”’')
                  .fontSize(20)
                  .fontColor('#6b7280');

                TextInput({
                  placeholder: 'è¯·è¾“å…¥å¯†ç ',
                  text: this.password
                })
                  .onChange((val: string) => this.password = val)
                  .type(this.showPassword ? InputType.Normal : InputType.Password)
                  .fontSize(16)
                  .backgroundColor('transparent')
                  .border({ width: 0 })
                  .layoutWeight(1)
                  .placeholderColor('#9ca3af')
                  .fontColor('#1f2937');

                Button(this.showPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸')
                  .backgroundColor('transparent')
                  .fontSize(18)
                  .fontColor('#6b7280')
                  .padding(0)
                  .width(32)
                  .height(32)
                  .onClick(() => {
                    this.showPassword = !this.showPassword;
                  });
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 14, bottom: 14 })
              .backgroundColor('#f8fafc')
              .borderRadius(12)
              .border({ width: 1, color: '#e2e8f0' });
            }

            // ç¡®è®¤å¯†ç è¾“å…¥æ¡†
            Column({ space: 8 }) {
              Row({ space: 12 }) {
                Text('ğŸ”')
                  .fontSize(20)
                  .fontColor('#6b7280');

                TextInput({
                  placeholder: 'è¯·ç¡®è®¤å¯†ç ',
                  text: this.confirm
                })
                  .onChange((val: string) => this.confirm = val)
                  .type(this.showConfirmPassword ? InputType.Normal : InputType.Password)
                  .fontSize(16)
                  .backgroundColor('transparent')
                  .border({ width: 0 })
                  .layoutWeight(1)
                  .placeholderColor('#9ca3af')
                  .fontColor('#1f2937');

                Button(this.showConfirmPassword ? 'ğŸ™ˆ' : 'ğŸ‘ï¸')
                  .backgroundColor('transparent')
                  .fontSize(18)
                  .fontColor('#6b7280')
                  .padding(0)
                  .width(32)
                  .height(32)
                  .onClick(() => {
                    this.showConfirmPassword = !this.showConfirmPassword;
                  });
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 14, bottom: 14 })
              .backgroundColor('#f8fafc')
              .borderRadius(12)
              .border({ width: 1, color: '#e2e8f0' });
            }

            // å¯†ç å¼ºåº¦æç¤º
            if (this.password !== '') {
              Column({ space: 8 }) {
                Text('å¯†ç å¼ºåº¦')
                  .fontSize(14)
                  .fontColor('#6b7280');

                Row({ space: 4 }) {
                  ForEach(Array.from({length: 4}), (_: number, index: number) => {
                    Divider()
                      .strokeWidth(4)
                      .color(this.getPasswordStrengthColor(index))
                      .layoutWeight(1);
                  }, (_: number, index: number) => index.toString());
                }
                .height(4);

                Text(this.getPasswordStrengthText())
                  .fontSize(12)
                  .fontColor(this.getPasswordStrengthTextColor());
              }
              .width('100%')
              .padding(12)
              .backgroundColor('#f8fafc')
              .borderRadius(8)
              .border({ width: 1, color: '#e2e8f0' });
            }

            // é”™è¯¯ä¿¡æ¯
            if (this.errorMsg !== '') {
              Row({ space: 8 }) {
                Text('âš ï¸')
                  .fontSize(16);

                Text(this.errorMsg)
                  .fontSize(14)
                  .fontColor('#ef4444')
                  .flexGrow(1);
              }
              .width('100%')
              .padding(12)
              .backgroundColor('#fef2f2')
              .borderRadius(8)
              .border({ width: 1, color: '#fecaca' });
            }

            // æ³¨å†ŒæŒ‰é’®
            Button(this.isLoading ? 'æ³¨å†Œä¸­...' : 'ğŸš€ ç«‹å³æ³¨å†Œ')
              .width('100%')
              .height(52)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor('#ffffff')
              .backgroundColor(this.isLoading ? '#9ca3af' : '#10b981')
              .borderRadius(12)
              .shadow({ radius: 8, color: '#10b98130', offsetX: 0, offsetY: 4 })
              .enabled(!this.isLoading)
              .onClick(() => {
                if (this.phone === '' || this.password === '' || this.confirm === '') {
                  this.errorMsg = 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯';
                  return;
                }

                if (!this.isValidPhone(this.phone)) {
                  this.errorMsg = 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼';
                  return;
                }

                if (this.password.length < 6) {
                  this.errorMsg = 'å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦';
                  return;
                }

                if (this.password !== this.confirm) {
                  this.errorMsg = 'ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´';
                  return;
                }

                this.isLoading = true;
                this.errorMsg = '';

                // æ¨¡æ‹Ÿæ³¨å†Œå»¶è¿Ÿ
                setTimeout(() => {
                  userDB.push({ phone: this.phone, password: this.password });
                  router.pushUrl({ url: 'pages/LoginPage' }).catch((err: Error) => {
                    console.error('Navigation failed:', err.message);
                  });
                  this.isLoading = false;
                }, 100);
              });

            // åˆ†å‰²çº¿
            Row({ space: 16 }) {
              Divider()
                .strokeWidth(1)
                .color('#e2e8f0')
                .layoutWeight(1);

              Text('æˆ–')
                .fontSize(14)
                .fontColor('#6b7280');

              Divider()
                .strokeWidth(1)
                .color('#e2e8f0')
                .layoutWeight(1);
            }
            .width('100%');

            // è¿”å›ç™»å½•æŒ‰é’®
            Button('ğŸ”™ è¿”å›ç™»å½•')
              .width('100%')
              .height(48)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#10b981')
              .backgroundColor('#ffffff')
              .borderRadius(12)
              .border({ width: 2, color: '#10b981' })
              .shadow({ radius: 4, color: '#10b98120', offsetX: 0, offsetY: 2 })
              .onClick(() => {
                router.back();
              });

            // åº•éƒ¨æç¤º
            Text('æ³¨å†Œå³è¡¨ç¤ºæ‚¨åŒæ„æˆ‘ä»¬çš„æœåŠ¡æ¡æ¬¾å’Œéšç§æ”¿ç­–')
              .fontSize(12)
              .fontColor('#6b7280')
              .textAlign(TextAlign.Center)
              .lineHeight(18)
              .margin({ top: 16 });
          }
          .width('100%')
          .padding(24)
          .backgroundColor('#ffffff')
          .borderRadius(24)
          .shadow({ radius: 30, color: '#00000020', offsetX: 0, offsetY: 15 })
          .margin({ left: 20, right: 20, bottom: 40 });
        }
        .width('100%')
        .padding({ left: 0, right: 0, top: 20, bottom: 40 });
      }
      .width('100%')
      .height('100%')
      .scrollBar(BarState.Auto)
      .edgeEffect(EdgeEffect.Spring);
    }
    .width('100%')
    .height('100%');
  }

  // è·å–å¯†ç å¼ºåº¦é¢œè‰²
  getPasswordStrengthColor(index: number): string {
    const strength = this.calculatePasswordStrength();
    if (index < strength) {
      switch (strength) {
        case 1: return '#ef4444'; // å¼±
        case 2: return '#f59e0b'; // ä¸€èˆ¬
        case 3: return '#3b82f6'; // è‰¯å¥½
        case 4: return '#10b981'; // å¼º
        default: return '#e5e7eb';
      }
    }
    return '#e5e7eb';
  }

  // è·å–å¯†ç å¼ºåº¦æ–‡æœ¬
  getPasswordStrengthText(): string {
    const strength = this.calculatePasswordStrength();
    switch (strength) {
      case 1: return 'å¼±';
      case 2: return 'ä¸€èˆ¬';
      case 3: return 'è‰¯å¥½';
      case 4: return 'å¼º';
      default: return '';
    }
  }

  // è·å–å¯†ç å¼ºåº¦æ–‡æœ¬é¢œè‰²
  getPasswordStrengthTextColor(): string {
    const strength = this.calculatePasswordStrength();
    switch (strength) {
      case 1: return '#ef4444';
      case 2: return '#f59e0b';
      case 3: return '#3b82f6';
      case 4: return '#10b981';
      default: return '#6b7280';
    }
  }

  // è®¡ç®—å¯†ç å¼ºåº¦
  calculatePasswordStrength(): number {
    let strength = 0;
    if (this.password.length >= 6) strength++;
    if (/[a-z]/.test(this.password)) strength++;
    if (/[A-Z]/.test(this.password)) strength++;
    if (/[0-9]/.test(this.password)) strength++;
    return strength;
  }

  // éªŒè¯æ‰‹æœºå·æ ¼å¼
  isValidPhone(phone: string): boolean {
    const phoneRegex = /^1[3-9]\d{9}$/;
    return phoneRegex.test(phone);
  }
}